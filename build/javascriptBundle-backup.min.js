(function(){function t(){var t=[],e=[],n={};return n.enqueue=function(e){t.push(e)},n.dequeue=function(){if(0===e.length)for(var n=t.length,r=0;n>r;r++)e.push(t.pop());return e.pop()},n.isEmpty=function(){return 0===t.length&&0===e.length},n}var e={allocationEdit:'<h1>Edit allocations for accademic year beginning {{year}}</h1><hr /><div> {{#staircases}} <div class="allocationBlock"><h2>{{{name}}}</h2> {{#rooms}} <form data-old-allocation="{{allocation}}" data-roomid="{{id}}"> {{name}}: <input name="allocation" type="text" value="{{allocation}}" /></form> {{/rooms}} </div> {{/staircases}}</div>',choosingOrderEdit:'<div id="tabs"><ul><li><a href="#tabs-1">First Years</a></li><li><a href="#tabs-2">Second Years</a></li><li><a href="#tabs-3">Third Years</a></li></ul><div id="tabs-1"><ul id="sortable" class="sortable"><li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>Joe Blogs <button> Delete</button></li><li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>John Smith </li></ul></div><div id="tabs-2"> Second Years </div><div id="tabs-3"> Third Years </div></div>',markdownEdit:'<form><div class="wmd-panel"><div id="wmd-button-bar"></div><textarea class="wmd-input" id="wmd-input" name="content">{{{Content}}}</textarea></div><div id="wmd-preview" class="wmd-panel wmd-preview"></div><input type="submit" value="Save" /></form><div id="getImage" class="dialog" title="Insert Image"><label> Select an image to upload</label><br /><input type="file" required /></div><div id="busy" class="dialog" title="Uploading"><div class="ajaxLoader"></div></div><div id="getURL" class="dialog" title="Insert Hyperlink"><form><label> http://example.com/ "optional title"</label><br /><input name="fileUpload" type="url" value="http://" /><br /></form></div>',NavigationList:'{{#Links}} <a href="{{url}}" {{#selected}}class="Selected"{{/selected}}>{{{name}}}</a>{{/Links}}',navigationTableEdit:'<h2> Add New</h2><form><label>ID</label><input name="id" type="text" /><label>Name</label><input name="name" type="text" required /><br /><label>Parent ID</label><input name="parentid" type="text" value="{{parentid}}" /><label>Type</label><select name="type"><option>staircase</option><option selected>room</option><option>page</option><option>special</option></select><br /><label>Weight</label><input name="weight" type="number" /><label>Bathroom Sharing</label><input name="bathroomsharing" type="number" value="{{bathroomsharing}}" /><br /><label>Rent Band</label><input name="rentband" type="number" value="{{rentband}}" /><label>Floor</label><input name="floor" type="number" value="{{floor}}" /><br /><input type="submit" value="Save" /></form><h2> Edit Existing</h2><table><tr><th> ID </th><th> Name </th><th> Parent ID </th><th> Type </th><th> Weight </th><th> Bathroom Sharing </th><th> Rent Band </th><th> Floor </th><th></th></tr> {{#Navigation}} <tr itemid="{{id}}"><td itemprop="id" data-type="text"><!--Required but could be ""--><div>{{id}}</div><input style="display: none; width:110px" type="text" value="{{id}}" /></td><td itemprop="name" data-type="text"><div>{{{name}}}</div><input style="display: none; width:115px" type="text" required value="{{name}}" /></td><td itemprop="parentid" data-type="text"><!--Required but could be ""--><div>{{parentid}}</div><input style="display: none; width:40px" type="text" value="{{parentid}}" /></td><td itemprop="type" data-type="text" style="width: 84px"><div>{{type}}</div><select style="display: none;" required ><option {{#isStaircase}}selected{{/isStaircase}}>staircase</option><option {{#isRoom}}selected{{/isRoom}}>room</option><option {{#isPage}}selected{{/isPage}}>page</option><option {{#isSpecial}}selected{{/isSpecial}}>special</option></select></td><td itemprop="weight" data-type="text"><div>{{weight}}</div><input style="display: none; width: 45px" type="number" value="{{weight}}" /></td><td itemprop="bathroomsharing" data-type="text"><div>{{bathroomsharing}}</div><input style="display: none; width:30px" type="number" value="{{bathroomsharing}}" /></td><td itemprop="rentband" data-type="text"><div>{{rentband}}</div><input style="display: none; width:30px" type="number" value="{{rentband}}" /></td><td itemprop="floor" data-type="text"><div>{{floor}}</div><input style="display: none; width:30px" type="number" value="{{floor}}" /></td><td><button>Delete</button></td></tr> {{/Navigation}}</table>',projector:'{{#staircases}}<div class="projectorBlock"><h1><a href="{{url}}">{{{name}}}</a></h1><ul> {{#rooms}} <li id="{{id}}" class="{{css}}"><a href="{{url}}">{{{name}}}<span class="allocationDisplayPart"> - <span class="allocationDisplay" data-roomid="{{id}}"></span></span></a></li> {{/rooms}} </ul></div>{{/staircases}}',room:'{{#rentband}}<table class="horizontalTable"><tr><th> Bathroom </th><td> {{bathroom}} </td></tr><tr><th> Rent Band </th><td> {{rentBandDescription}} </td></tr><tr><th> Floor </th><td> {{floorDescription}} </td></tr><tr><th> Current Allocation </th><td><span class="allocationDisplay" data-roomid="{{id}}" data-year="current"></span></td></tr><tr><th> Next Year\'s Allocation </th><td><span class="allocationDisplay" data-roomid="{{id}}" data-year="next"></span></td></tr></table>{{/rentband}}',staircase:'{{#Floors}}<h2> {{Name}}</h2><ul> {{#Rooms}} <li><a href="{{url}}">{{nameSingleLine}}{{#rentband}} - {{#bathroom}}{{bathroom}}, {{/bathroom}}{{rentBandDescription}}, <span class="allocationDisplay" data-roomid="{{id}}"></span>{{/rentband}}</a></li> {{/Rooms}}</ul>{{/Floors}}'};"function"!=typeof Object.create&&function(){var t=function(){};Object.create=function(e){if(arguments.length>1)throw Error("Second argument not supported");if(null===e)throw Error("Cannot set a null [[Prototype]]");if("object"!=typeof e)throw TypeError("Argument must be an object");return t.prototype=e,new t}}(),window.onerror=function(t,e){return-1===location.href.indexOf("drupal-test-site")&&e&&-1!=e.indexOf(location.host)&&confirm("An error was encountered, refresh the page to fix it?")?(location.reload(!1),!1):void 0};var n={version:"0.8",map:function(t){return n.routes.defined.hasOwnProperty(t)?n.routes.defined[t]:new n.core.route(t)},root:function(t){n.routes.root=t},rescue:function(t){n.routes.rescue=t},history:{pushState:function(t,e,r){n.history.supported?n.dispatch(r)&&history.pushState(t,e,r):n.history.fallback&&(window.location.hash="#"+r)},popState:function(){n.dispatch(document.location.pathname)},listen:function(t){if(n.history.supported=!(!window.history||!window.history.pushState),n.history.fallback=t,n.history.supported)window.onpopstate=n.history.popState;else if(n.history.fallback){for(route in n.routes.defined)"#"!=route.charAt(0)&&(n.routes.defined["#"+route]=n.routes.defined[route],n.routes.defined["#"+route].path="#"+route);n.listen()}}},match:function(t,e){var r,o,a,i,s,l={},c=null;for(c in n.routes.defined)if(null!==c&&void 0!==c)for(c=n.routes.defined[c],r=c.partition(),i=0;r.length>i;i++){if(o=r[i],s=t,o.search(/:/)>0)for(a=0;o.split("/").length>a;a++)s.split("/").length>a&&":"===o.split("/")[a].charAt(0)&&(l[o.split("/")[a].replace(/:/,"")]=s.split("/")[a],s=s.replace(s.split("/")[a],o.split("/")[a]));if(o===s)return e&&(c.params=l),c}return null},dispatch:function(t){var e,r;if(n.routes.current!==t){if(n.routes.previous=n.routes.current,n.routes.current=t,r=n.match(t,!0),n.routes.previous&&(e=n.match(n.routes.previous),null!==e&&null!==e.do_exit&&e.do_exit()),null!==r)return r.run(),!0;null!==n.routes.rescue&&n.routes.rescue()}},listen:function(){var t=function(){n.dispatch(location.hash)};""===location.hash?null!==n.routes.root&&(location.hash=n.routes.root):n.dispatch(location.hash),"onhashchange"in window?window.onhashchange=t:setInterval(t,50)},core:{route:function(t){this.path=t,this.action=null,this.do_enter=[],this.do_exit=null,this.params={},n.routes.defined[t]=this}},routes:{current:null,root:null,rescue:null,previous:null,defined:{}}};n.core.route.prototype={to:function(t){return this.action=t,this},enter:function(t){return t instanceof Array?this.do_enter=this.do_enter.concat(t):this.do_enter.push(t),this},exit:function(t){return this.do_exit=t,this},partition:function(){for(var t,e,n=[],r=[],o=/\(([^}]+?)\)/g;t=o.exec(this.path);)n.push(t[1]);for(r.push(this.path.split("(")[0]),e=0;n.length>e;e++)r.push(r[r.length-1]+n[e]);return r},run:function(){var t,e,r=!1;if(n.routes.defined[this.path].hasOwnProperty("do_enter")&&n.routes.defined[this.path].do_enter.length>0)for(t=0;n.routes.defined[this.path].do_enter.length>t;t++)if(e=n.routes.defined[this.path].do_enter[t](),e===!1){r=!0;break}r||n.routes.defined[this.path].action()}};var r;r="object"==typeof exports&&"function"==typeof require?exports:{},function(){function t(t){return t}function e(){return!1}function n(){}function o(){}n.prototype={chain:function(e,n){var r=this[e];if(!r)throw Error("unknown hook "+e);this[e]=r===t?n:function(t){return n(r(t))}},set:function(t,e){if(!this[t])throw Error("unknown hook "+t);this[t]=e},addNoop:function(e){this[e]=t},addFalse:function(t){this[t]=e}},r.HookCollection=n,o.prototype={set:function(t,e){this["s_"+t]=e},get:function(t){return this["s_"+t]}},r.Converter=function(){function t(t){return t=t.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,function(t,e,n,r,o,a){return e=e.toLowerCase(),L.set(e,x(n)),o?r:(a&&O.set(e,a.replace(/"/g,"&quot;")),"")})}function e(t){return t=t.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,r),t=t.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,r),t=t.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,r),t=t.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g,r),t=t.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,r)}function r(t,e){var n=e;return n=n.replace(/^\n+/,""),n=n.replace(/\n+$/g,""),n="\n\n~K"+(B.push(n)-1)+"K\n\n"}function a(t,n){t=f(t);var r="<hr />\n";return t=t.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,r),t=t.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,r),t=t.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,r),t=h(t),t=m(t),t=k(t),t=e(t),t=T(t,n)}function i(t){return t=b(t),t=s(t),t=C(t),t=u(t),t=l(t),t=$(t),t=t.replace(/~P/g,"://"),t=x(t),t=w(t),t=t.replace(/  +\n/g," <br>\n")}function s(t){var e=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;return t=t.replace(e,function(t){var e=t.replace(/(.)<\/?code>(?=.)/g,"$1`");return e=N(e,"!"==t.charAt(1)?"\\`*_/":"\\`*_")})}function l(t){return t=t.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,c),t=t.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,c),t=t.replace(/(\[([^\[\]]+)\])()()()()()/g,c)}function c(t,e,n,r,o,a,i,s){void 0==s&&(s="");var l=e,c=n.replace(/:\/\//g,"~P"),u=r.toLowerCase(),p=o,f=s;if(""==p)if(""==u&&(u=c.toLowerCase().replace(/ ?\n/g," ")),p="#"+u,void 0!=L.get(u))p=L.get(u),void 0!=O.get(u)&&(f=O.get(u));else{if(!(l.search(/\(\s*\)$/m)>-1))return l;p=""}p=D(p),p=N(p,"*_");var h='<a href="'+p+'"';return""!=f&&(f=d(f),f=N(f,"*_"),h+=' title="'+f+'"'),h+=">"+c+"</a>"}function u(t){return t=t.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,p),t=t.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,p)}function d(t){return t.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function p(t,e,n,r,o,a,i,s){var l=e,c=n,u=r.toLowerCase(),p=o,f=s;if(f||(f=""),""==p){if(""==u&&(u=c.toLowerCase().replace(/ ?\n/g," ")),p="#"+u,void 0==L.get(u))return l;p=L.get(u),void 0!=O.get(u)&&(f=O.get(u))}c=N(d(c),"*_[]()"),p=N(p,"*_");var h='<img src="'+p+'" alt="'+c+'"';return f=d(f),f=N(f,"*_"),h+=' title="'+f+'"',h+=" />"}function f(t){return t=t.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(t,e){return"<h1>"+i(e)+"</h1>\n\n"}),t=t.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(t,e){return"<h2>"+i(e)+"</h2>\n\n"}),t=t.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(t,e,n){var r=e.length;return"<h"+r+">"+i(n)+"</h"+r+">\n\n"})}function h(t){t+="~0";var e=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return _?t=t.replace(e,function(t,e,n){var r=e,o=n.search(/[*+-]/g)>-1?"ul":"ol",a=g(r,o);return a=a.replace(/\s+$/,""),a="<"+o+">"+a+"</"+o+">\n"}):(e=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,t=t.replace(e,function(t,e,n,r){var o=e,a=n,i=r.search(/[*+-]/g)>-1?"ul":"ol",s=g(a,i);return s=o+"<"+i+">\n"+s+"</"+i+">\n"})),t=t.replace(/~0/,"")}function g(t,e){_++,t=t.replace(/\n{2,}$/,"\n"),t+="~0";var n=H[e],r=RegExp("(^[ \\t]*)("+n+")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1("+n+")[ \\t]+))","gm"),o=!1;return t=t.replace(r,function(t,e,n,r){var s=r,l=/\n\n$/.test(s),c=l||s.search(/\n{2,}/)>-1;return c||o?s=a(E(s),!0):(s=h(E(s)),s=s.replace(/\n$/,""),s=i(s)),o=l,"<li>"+s+"</li>\n"}),t=t.replace(/~0/g,""),_--,t}function m(t){return t+="~0",t=t.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(t,e,n){var r=e,o=n;return r=y(E(r)),r=I(r),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,""),r="<pre><code>"+r+"\n</code></pre>","\n\n"+r+"\n\n"+o}),t=t.replace(/~0/,"")}function v(t){return t=t.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(B.push(t)-1)+"K\n\n"}function b(t){return t=t.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(t,e,n,r){var o=r;return o=o.replace(/^([ \t]*)/g,""),o=o.replace(/[ \t]*$/g,""),o=y(o),o=o.replace(/:\/\//g,"~P"),e+"<code>"+o+"</code>"})}function y(t){return t=t.replace(/&/g,"&amp;"),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=N(t,"*_{}[]\\",!1)}function w(t){return t=t.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,"$1<strong>$3</strong>$4"),t=t.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,"$1<em>$3</em>$4")}function k(t){return t=t.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(t,e){var n=e;return n=n.replace(/^[ \t]*>[ \t]?/gm,"~0"),n=n.replace(/~0/g,""),n=n.replace(/^[ \t]+$/gm,""),n=a(n),n=n.replace(/(^|\n)/g,"$1  "),n=n.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(t,e){var n=e;return n=n.replace(/^  /gm,"~0"),n=n.replace(/~0/g,"")}),v("<blockquote>\n"+n+"\n</blockquote>")})}function T(t,e){t=t.replace(/^\n+/g,""),t=t.replace(/\n+$/g,"");for(var n=t.split(/\n{2,}/g),r=[],o=/~K(\d+)K/,a=n.length,s=0;a>s;s++){var l=n[s];o.test(l)?r.push(l):/\S/.test(l)&&(l=i(l),l=l.replace(/^([ \t]*)/g,"<p>"),l+="</p>",r.push(l))}if(!e){a=r.length;for(var s=0;a>s;s++)for(var c=!0;c;)c=!1,r[s]=r[s].replace(/~K(\d+)K/g,function(t,e){return c=!0,B[e]})}return r.join("\n\n")}function x(t){return t=t.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),t=t.replace(/<(?![a-z\/?\$!])/gi,"&lt;")}function C(t){return t=t.replace(/\\(\\)/g,A),t=t.replace(/\\([`*_{}\[\]()>#+-.!])/g,A)}function $(t){t=t.replace(/(^|\s)(https?|ftp)(:\/\/[-A-Z0-9+&@#\/%?=~_|\[\]\(\)!:,\.;]*[-A-Z0-9+&@#\/%=~_|\[\]])($|\W)/gi,"$1<$2$3>$4");var e=function(t,e){return'<a href="'+e+'">'+R.plainLinkText(e)+"</a>"};return t=t.replace(/<((https?|ftp):[^'">\s]+)>/gi,e)}function S(t){return t=t.replace(/~E(\d+)E/g,function(t,e){var n=parseInt(e);return String.fromCharCode(n)})}function E(t){return t=t.replace(/^(\t|[ ]{1,4})/gm,"~0"),t=t.replace(/~0/g,"")}function I(t){if(!/\t/.test(t))return t;var e,n=["    ","   ","  "," "],r=0;return t.replace(/[\n\t]/g,function(t,o){return"\n"===t?(r=o+1,t):(e=(o-r)%4,r=o+1,n[e])})}function D(t){if(!t)return"";var e=t.length;return t.replace(F,function(n,r){return"~D"==n?"%24":":"!=n||r!=e-1&&!/[0-9\/]/.test(t.charAt(r+1))?"%"+n.charCodeAt(0).toString(16):":"})}function N(t,e,n){var r="(["+e.replace(/([\[\]\\])/g,"\\$1")+"])";n&&(r="\\\\"+r);var o=RegExp(r,"g");return t=t.replace(o,A)}function A(t,e){var n=e.charCodeAt(0);return"~E"+n+"E"}var R=this.hooks=new n;R.addNoop("plainLinkText"),R.addNoop("preConversion"),R.addNoop("postConversion");var L,O,B,_;this.makeHtml=function(n){if(L)throw Error("Recursive call to converter.makeHtml");return L=new o,O=new o,B=[],_=0,n=R.preConversion(n),n=n.replace(/~/g,"~T"),n=n.replace(/\$/g,"~D"),n=n.replace(/\r\n/g,"\n"),n=n.replace(/\r/g,"\n"),n="\n\n"+n+"\n\n",n=I(n),n=n.replace(/^[ \t]+$/gm,""),n=e(n),n=t(n),n=a(n),n=S(n),n=n.replace(/~D/g,"$$"),n=n.replace(/~T/g,"~"),n=R.postConversion(n),B=O=L=null,n};var H={ol:"\\d+[.]",ul:"[*+-]"},F=/(?:["'*()[\]:]|~D)/g}}(),function(){function t(t){return t.replace(/<[^>]*>?/gi,e)}function e(t){return t.match(i)||t.match(s)||t.match(l)?t:""}function n(t){if(""==t)return"";var e=/<\/?\w+[^>]*(\s|$|>)/g,n=t.toLowerCase().match(e),r=(n||[]).length;if(0==r)return t;for(var o,a,i,s="<p><img><br><li><hr>",l=[],c=[],u=!1,d=0;r>d;d++)if(o=n[d].replace(/<\/?(\w+).*/,"$1"),!(l[d]||s.search("<"+o+">")>-1)){if(a=n[d],i=-1,!/^<\//.test(a))for(var p=d+1;r>p;p++)if(!l[p]&&n[p]=="</"+o+">"){i=p;break}-1==i?u=c[d]=!0:l[i]=!0}if(!u)return t;var d=0;return t=t.replace(e,function(t){var e=c[d]?"":t;return d++,e})}var o,a;"object"==typeof exports&&"function"==typeof require?(o=exports,a=require("./Markdown.Converter").Converter):(o=r,a=o.Converter),o.getSanitizingConverter=function(){var e=new a;return e.hooks.chain("postConversion",t),e.hooks.chain("postConversion",n),e};var i=/^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i,s=/^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i,l=/^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i}(),function(){function t(){}function e(t){this.buttonBar=p.getElementById("wmd-button-bar"+t),this.preview=p.getElementById("wmd-preview"+t),this.input=p.getElementById("wmd-input"+t)}function n(t,e){var n,r,a,i=this,s=[],l=0,u="none",d=function(t,e){u!=t&&(u=t,e||f()),m.isIE&&"moving"==u?a=null:r=setTimeout(p,1)},p=function(t){a=new o(e,t),r=void 0};this.setCommandMode=function(){u="command",f(),r=setTimeout(p,0)},this.canUndo=function(){return l>1},this.canRedo=function(){return s[l+1]?!0:!1},this.undo=function(){i.canUndo()&&(n?(n.restore(),n=null):(s[l]=new o(e),s[--l].restore(),t&&t())),u="none",e.input.focus(),p()},this.redo=function(){i.canRedo()&&(s[++l].restore(),t&&t()),u="none",e.input.focus(),p()};var f=function(){var r=a||new o(e);return r?"moving"==u?(n||(n=r),void 0):(n&&(s[l-1].text!=n.text&&(s[l++]=n),n=null),s[l++]=r,s[l+1]=null,t&&t(),void 0):!1},h=function(t){var e=!1;if(t.ctrlKey||t.metaKey){var n=t.charCode||t.keyCode,r=String.fromCharCode(n);switch(r){case"y":i.redo(),e=!0;break;case"z":t.shiftKey?i.redo():i.undo(),e=!0}}return e?(t.preventDefault&&t.preventDefault(),window.event&&(window.event.returnValue=!1),void 0):void 0},g=function(t){if(!t.ctrlKey&&!t.metaKey){var e=t.keyCode;e>=33&&40>=e||e>=63232&&63235>=e?d("moving"):8==e||46==e||127==e?d("deleting"):13==e?d("newlines"):27==e?d("escape"):(16>e||e>20)&&91!=e&&d("typing")}},v=function(){c.addEvent(e.input,"keypress",function(t){!t.ctrlKey&&!t.metaKey||89!=t.keyCode&&90!=t.keyCode||t.preventDefault()});var t=function(){(m.isIE||a&&a.text!=e.input.value)&&void 0==r&&(u="paste",f(),p())};c.addEvent(e.input,"keydown",h),c.addEvent(e.input,"keydown",g),c.addEvent(e.input,"mousedown",function(){d("moving")}),e.input.onpaste=t,e.input.ondrop=t},b=function(){v(),p(!0),f()};b()}function o(e,n){var r=this,o=e.input;this.init=function(){c.isVisible(o)&&(n||!p.activeElement||p.activeElement===o)&&(this.setInputAreaSelectionStartEnd(),this.scrollTop=o.scrollTop,(!this.text&&o.selectionStart||0===o.selectionStart)&&(this.text=o.value))},this.setInputAreaSelection=function(){if(c.isVisible(o))if(void 0===o.selectionStart||m.isOpera){if(p.selection){if(p.activeElement&&p.activeElement!==o)return;o.focus();var t=o.createTextRange();t.moveStart("character",-o.value.length),t.moveEnd("character",-o.value.length),t.moveEnd("character",r.end),t.moveStart("character",r.start),t.select()}}else o.focus(),o.selectionStart=r.start,o.selectionEnd=r.end,o.scrollTop=r.scrollTop},this.setInputAreaSelectionStartEnd=function(){if(e.ieCachedRange||!o.selectionStart&&0!==o.selectionStart){if(p.selection){r.text=c.fixEolChars(o.value);var t=e.ieCachedRange||p.selection.createRange(),n=c.fixEolChars(t.text),a="",i=a+n+a;t.text=i;var s=c.fixEolChars(o.value);t.moveStart("character",-i.length),t.text=n,r.start=s.indexOf(a),r.end=s.lastIndexOf(a)-a.length;var l=r.text.length-c.fixEolChars(o.value).length;if(l){for(t.moveStart("character",-n.length);l--;)n+="\n",r.end+=1;t.text=n}e.ieCachedRange&&(r.scrollTop=e.ieCachedScrollTop),e.ieCachedRange=null,this.setInputAreaSelection()}}else r.start=o.selectionStart,r.end=o.selectionEnd},this.restore=function(){void 0!=r.text&&r.text!=o.value&&(o.value=r.text),this.setInputAreaSelection(),o.scrollTop=r.scrollTop},this.getChunks=function(){var e=new t;return e.before=c.fixEolChars(r.text.substring(0,r.start)),e.startTag="",e.selection=c.fixEolChars(r.text.substring(r.start,r.end)),e.endTag="",e.after=c.fixEolChars(r.text.substring(r.end)),e.scrollTop=r.scrollTop,e},this.setChunks=function(t){t.before=t.before+t.startTag,t.after=t.endTag+t.after,this.start=t.before.length,this.end=t.before.length+t.selection.length,this.text=t.before+t.selection+t.after,this.scrollTop=t.scrollTop},this.init()}function a(t,e,n){var r,o,a,i=3e3,s="delayed",l=function(t,e){c.addEvent(t,"input",e),t.onpaste=e,t.ondrop=e,c.addEvent(t,"keypress",e),c.addEvent(t,"keydown",e)},d=function(){var t=0;return window.innerHeight?t=window.pageYOffset:p.documentElement&&p.documentElement.scrollTop?t=p.documentElement.scrollTop:p.body&&(t=p.body.scrollTop),t},f=function(){if(e.preview){var n=e.input.value;if(!n||n!=a){a=n;var r=(new Date).getTime();n=t.makeHtml(n);var i=(new Date).getTime();o=i-r,x(n)}}},h=function(){if(r&&(clearTimeout(r),r=void 0),"manual"!==s){var t=0;"delayed"===s&&(t=o),t>i&&(t=i),r=setTimeout(f,t)}},g=function(t){return t.clientHeight>=t.scrollHeight?1:t.scrollTop/(t.scrollHeight-t.clientHeight)},v=function(){e.preview&&(e.preview.scrollTop=(e.preview.scrollHeight-e.preview.clientHeight)*g(e.preview))};this.refresh=function(t){t?(a="",f()):h()},this.processingTime=function(){return o};var b,y=!0,w=function(t){var n=e.preview,r=n.parentNode,o=n.nextSibling;r.removeChild(n),n.innerHTML=t,o?r.insertBefore(n,o):r.appendChild(n)},k=function(t){e.preview.innerHTML=t},T=function(t){if(b)return b(t);try{k(t),b=k}catch(e){b=w,b(t)}},x=function(t){var r=u.getTop(e.input)-d();if(e.preview&&(T(t),n()),v(),y)return y=!1,void 0;var o=u.getTop(e.input)-d();m.isIE?setTimeout(function(){window.scrollBy(0,o-r)},0):window.scrollBy(0,o-r)},C=function(){l(e.input,h),f(),e.preview&&(e.preview.scrollTop=0)};C()}function i(t,e,n,r,a,i){function s(t){if(g.focus(),t.textOp){n&&n.setCommandMode();var a=new o(e);if(!a)return;var i=a.getChunks(),s=function(){g.focus(),i&&a.setChunks(i),a.restore(),r.refresh()},l=t.textOp(i,s);l||s()}t.execute&&t.execute(n)}function l(t,n){var r="0px",o="-20px",a="-40px",i=t.getElementsByTagName("span")[0];n?(i.style.backgroundPosition=t.XShift+" "+r,t.onmouseover=function(){i.style.backgroundPosition=this.XShift+" "+a},t.onmouseout=function(){i.style.backgroundPosition=this.XShift+" "+r},m.isIE&&(t.onmousedown=function(){p.activeElement&&p.activeElement!==e.input||(e.ieCachedRange=document.selection.createRange(),e.ieCachedScrollTop=e.input.scrollTop)}),t.isHelp||(t.onclick=function(){return this.onmouseout&&this.onmouseout(),s(this),!1})):(i.style.backgroundPosition=t.XShift+" "+o,t.onmouseover=t.onmouseout=t.onclick=function(){})}function u(t){return"string"==typeof t&&(t=a[t]),function(){t.apply(a,arguments)}}function d(){var n=e.buttonBar,r=document.createElement("ul");r.id="wmd-button-row"+t,r.className="wmd-button-row",r=n.appendChild(r);var o=0,a=function(e,n,a,i){var s=document.createElement("li");s.className="wmd-button",s.style.left=o+"px",o+=25;var c=document.createElement("span");return s.id=e+t,s.appendChild(c),s.title=n,s.XShift=a,i&&(s.textOp=i),l(s,!0),r.appendChild(s),s},s=function(e){var n=document.createElement("li");n.className="wmd-spacer wmd-spacer"+e,n.id="wmd-spacer"+e+t,r.appendChild(n),o+=25};v.bold=a("wmd-bold-button","Strong <strong> Ctrl+B","0px",u("doBold")),v.italic=a("wmd-italic-button","Emphasis <em> Ctrl+I","-20px",u("doItalic")),s(1),v.link=a("wmd-link-button","Hyperlink <a> Ctrl+L","-40px",u(function(t,e){return this.doLinkOrImage(t,e,!1)})),v.quote=a("wmd-quote-button","Blockquote <blockquote> Ctrl+Q","-60px",u("doBlockquote")),v.code=a("wmd-code-button","Code Sample <pre><code> Ctrl+K","-80px",u("doCode")),v.image=a("wmd-image-button","Image <img> Ctrl+G","-100px",u(function(t,e){return this.doLinkOrImage(t,e,!0)})),s(2),v.olist=a("wmd-olist-button","Numbered List <ol> Ctrl+O","-120px",u(function(t,e){this.doList(t,e,!0)})),v.ulist=a("wmd-ulist-button","Bulleted List <ul> Ctrl+U","-140px",u(function(t,e){this.doList(t,e,!1)})),v.heading=a("wmd-heading-button","Heading <h1>/<h2> Ctrl+H","-160px",u("doHeading")),v.hr=a("wmd-hr-button","Horizontal Rule <hr> Ctrl+R","-180px",u("doHorizontalRule")),s(3),v.undo=a("wmd-undo-button","Undo - Ctrl+Z","-200px",null),v.undo.execute=function(t){t&&t.undo()};var c=/win/.test(h.platform.toLowerCase())?"Redo - Ctrl+Y":"Redo - Ctrl+Shift+Z";if(v.redo=a("wmd-redo-button",c,"-220px",null),v.redo.execute=function(t){t&&t.redo()},i){var d=document.createElement("li"),p=document.createElement("span");d.appendChild(p),d.className="wmd-button wmd-help-button",d.id="wmd-help-button"+t,d.XShift="-240px",d.isHelp=!0,d.style.right="0px",d.title=i.title||k,d.onclick=i.handler,l(d,!0),r.appendChild(d),v.help=d}f()}function f(){n&&(l(v.undo,n.canUndo()),l(v.redo,n.canRedo()))}var g=e.input,v={};d();var b="keydown";m.isOpera&&(b="keypress"),c.addEvent(g,b,function(t){if((t.ctrlKey||t.metaKey)&&!t.altKey){var e=t.charCode||t.keyCode,n=String.fromCharCode(e).toLowerCase();switch(n){case"b":s(v.bold);break;case"i":s(v.italic);break;case"l":s(v.link);break;case"q":s(v.quote);break;case"k":s(v.code);break;case"g":s(v.image);break;case"o":s(v.olist);break;case"u":s(v.ulist);break;case"h":s(v.heading);break;case"r":s(v.hr);break;case"y":s(v.redo);break;case"z":t.shiftKey?s(v.redo):s(v.undo);break;default:return}t.preventDefault&&t.preventDefault(),window.event&&(window.event.returnValue=!1)}}),c.addEvent(g,"keyup",function(t){if(t.shiftKey&&!t.ctrlKey&&!t.metaKey){var e=t.charCode||t.keyCode;13===e&&(fakeButton={},fakeButton.textOp=u("doAutoindent"),s(fakeButton))}}),m.isIE&&c.addEvent(g,"keydown",function(t){var e=t.keyCode;return 27===e?!1:void 0}),this.setUndoRedoButtonStates=f}function s(t){this.hooks=t}function l(t){return t.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/,function(t,e,n){return e=e.replace(/\?.*$/,function(t){return t.replace(/\+/g," ")}),e=decodeURIComponent(e),e=encodeURI(e).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29"),e=e.replace(/\?.*$/,function(t){return t.replace(/\+/g,"%2b")}),n&&(n=n.trim?n.trim():n.replace(/^\s*/,"").replace(/\s*$/,""),n=$.trim(n).replace(/"/g,"quot;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;").replace(/</g,"&lt;").replace(/>/g,"&gt;")),n?e+' "'+n+'"':e})}var c={},u={},d={},p=window.document,f=window.RegExp,h=window.navigator,g={lineLength:72},m={isIE:/msie/.test(h.userAgent.toLowerCase()),isIE_5or6:/msie 6/.test(h.userAgent.toLowerCase())||/msie 5/.test(h.userAgent.toLowerCase()),isOpera:/opera/.test(h.userAgent.toLowerCase())},v='<p><b>Insert Hyperlink</b></p><p>http://example.com/ "optional title"</p>',b="<p><b>Insert Image</b></p><p>http://example.com/images/diagram.jpg \"optional title\"<br><br>Need <a href='http://www.google.com/search?q=free+image+hosting' target='_blank'>free image hosting?</a></p>",y="http://",w="http://",k="Markdown Editing Help";r.Editor=function(t,o,l){o=o||"";var c=this.hooks=new r.HookCollection;c.addNoop("onPreviewRefresh"),c.addNoop("postBlockquoteCreation"),c.addFalse("insertImageDialog"),this.getConverter=function(){return t};var u,d=this;this.run=function(){if(!u){u=new e(o);var r,f,h=new s(c),g=new a(t,u,function(){c.onPreviewRefresh()});/\?noundo/.test(p.location.href)||(r=new n(function(){g.refresh(),f&&f.setUndoRedoButtonStates()},u)),f=new i(o,u,r,g,h,l),f.setUndoRedoButtonStates();var m=d.refreshPreview=function(){g.refresh(!0)};m()}}},t.prototype.findTags=function(t,e){var n,r=this;t&&(n=c.extendRegExp(t,"","$"),this.before=this.before.replace(n,function(t){return r.startTag=r.startTag+t,""}),n=c.extendRegExp(t,"^",""),this.selection=this.selection.replace(n,function(t){return r.startTag=r.startTag+t,""})),e&&(n=c.extendRegExp(e,"","$"),this.selection=this.selection.replace(n,function(t){return r.endTag=t+r.endTag,""}),n=c.extendRegExp(e,"^",""),this.after=this.after.replace(n,function(t){return r.endTag=t+r.endTag,""}))},t.prototype.trimWhitespace=function(t){var e,n,r=this;t?e=n="":(e=function(t){return r.before+=t,""},n=function(t){return r.after=t+r.after,""}),this.selection=this.selection.replace(/^(\s*)/,e).replace(/(\s*)$/,n)},t.prototype.skipLines=function(t,e,n){void 0===t&&(t=1),void 0===e&&(e=1),t++,e++;var r,o;if(navigator.userAgent.match(/Chrome/)&&"X".match(/()./),this.selection=this.selection.replace(/(^\n*)/,""),this.startTag=this.startTag+f.$1,this.selection=this.selection.replace(/(\n*$)/,""),this.endTag=this.endTag+f.$1,this.startTag=this.startTag.replace(/(^\n*)/,""),this.before=this.before+f.$1,this.endTag=this.endTag.replace(/(\n*$)/,""),this.after=this.after+f.$1,this.before){for(r=o="";t--;)r+="\\n?",o+="\n";n&&(r="\\n*"),this.before=this.before.replace(new f(r+"$",""),o)}if(this.after){for(r=o="";e--;)r+="\\n?",o+="\n";n&&(r="\\n*"),this.after=this.after.replace(new f(r,""),o)}},c.isVisible=function(t){return window.getComputedStyle?"none"!==window.getComputedStyle(t,null).getPropertyValue("display"):t.currentStyle?"none"!==t.currentStyle.display:void 0},c.addEvent=function(t,e,n){t.attachEvent?t.attachEvent("on"+e,n):t.addEventListener(e,n,!1)},c.removeEvent=function(t,e,n){t.detachEvent?t.detachEvent("on"+e,n):t.removeEventListener(e,n,!1)},c.fixEolChars=function(t){return t=t.replace(/\r\n/g,"\n"),t=t.replace(/\r/g,"\n")},c.extendRegExp=function(t,e,n){(null===e||void 0===e)&&(e=""),(null===n||void 0===n)&&(n="");var r,o=""+t;return o=o.replace(/\/([gim]*)$/,""),r=f.$1,o=o.replace(/(^\/|\/$)/g,""),o=e+o+n,new f(o,r)},u.getTop=function(t,e){var n=t.offsetTop;if(!e)for(;t=t.offsetParent;)n+=t.offsetTop;return n},u.getHeight=function(t){return t.offsetHeight||t.scrollHeight},u.getWidth=function(t){return t.offsetWidth||t.scrollWidth},u.getPageSize=function(){var t,e,n,r;self.innerHeight&&self.scrollMaxY?(t=p.body.scrollWidth,e=self.innerHeight+self.scrollMaxY):p.body.scrollHeight>p.body.offsetHeight?(t=p.body.scrollWidth,e=p.body.scrollHeight):(t=p.body.offsetWidth,e=p.body.offsetHeight),self.innerHeight?(n=self.innerWidth,r=self.innerHeight):p.documentElement&&p.documentElement.clientHeight?(n=p.documentElement.clientWidth,r=p.documentElement.clientHeight):p.body&&(n=p.body.clientWidth,r=p.body.clientHeight);var o=Math.max(t,n),a=Math.max(e,r);return[o,a,n,r]},d.createBackground=function(){var t=p.createElement("div"),e=t.style;t.className="wmd-prompt-background",e.position="absolute",e.top="0",e.zIndex="1000",m.isIE?e.filter="alpha(opacity=50)":e.opacity="0.5";var n=u.getPageSize();return e.height=n[1]+"px",m.isIE?(e.left=p.documentElement.scrollLeft,e.width=p.documentElement.clientWidth):(e.left="0",e.width="100%"),p.body.appendChild(t),t},d.prompt=function(t,e,n){var r,o;void 0===e&&(e="");var a=function(t){var e=t.charCode||t.keyCode;27===e&&i(!0)},i=function(t){c.removeEvent(p.body,"keydown",a);var e=o.value;
return t?e=null:(e=e.replace("http://http://","http://"),e=e.replace("http://https://","https://"),e=e.replace("http://ftp://","ftp://"),-1===e.indexOf("http://")&&-1===e.indexOf("ftp://")&&-1===e.indexOf("https://")&&(e="http://"+e)),r.parentNode.removeChild(r),n(e),!1},s=function(){r=p.createElement("div"),r.className="wmd-prompt-dialog",r.style.padding="10px;",r.style.position="fixed",r.style.width="400px",r.style.zIndex="1001";var n=p.createElement("div");n.innerHTML=t,n.style.padding="5px",r.appendChild(n);var s=p.createElement("form"),l=s.style;s.onsubmit=function(){return i(!1)},l.padding="0",l.margin="0",l.cssFloat="left",l.width="100%",l.textAlign="center",l.position="relative",r.appendChild(s),o=p.createElement("input"),o.type="text",o.value=e,l=o.style,l.display="block",l.width="80%",l.marginLeft=l.marginRight="auto",s.appendChild(o);var d=p.createElement("input");d.type="button",d.onclick=function(){return i(!1)},d.value="OK",l=d.style,l.margin="10px",l.display="inline",l.width="7em";var f=p.createElement("input");f.type="button",f.onclick=function(){return i(!0)},f.value="Cancel",l=f.style,l.margin="10px",l.display="inline",l.width="7em",s.appendChild(d),s.appendChild(f),c.addEvent(p.body,"keydown",a),r.style.top="50%",r.style.left="50%",r.style.display="block",m.isIE_5or6&&(r.style.position="absolute",r.style.top=p.documentElement.scrollTop+200+"px",r.style.left="50%"),p.body.appendChild(r),r.style.marginTop=-(u.getHeight(r)/2)+"px",r.style.marginLeft=-(u.getWidth(r)/2)+"px"};setTimeout(function(){s();var t=e.length;if(void 0!==o.selectionStart)o.selectionStart=0,o.selectionEnd=t;else if(o.createTextRange){var n=o.createTextRange();n.collapse(!1),n.moveStart("character",-t),n.moveEnd("character",t),n.select()}o.focus()},0)};var T=s.prototype;T.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)",T.unwrap=function(t){var e=new f("([^\\n])\\n(?!(\\n|"+this.prefixes+"))","g");t.selection=t.selection.replace(e,"$1 $2")},T.wrap=function(t,e){this.unwrap(t);var n=new f("(.{1,"+e+"})( +|$\\n?)","gm"),r=this;t.selection=t.selection.replace(n,function(t,e){return new f("^"+r.prefixes,"").test(t)?t:e+"\n"}),t.selection=t.selection.replace(/\s+$/,"")},T.doBold=function(t,e){return this.doBorI(t,e,2,"strong text")},T.doItalic=function(t,e){return this.doBorI(t,e,1,"emphasized text")},T.doBorI=function(t,e,n,r){t.trimWhitespace(),t.selection=t.selection.replace(/\n{2,}/g,"\n");var o=/(\**$)/.exec(t.before)[0],a=/(^\**)/.exec(t.after)[0],i=Math.min(o.length,a.length);if(i>=n&&(2!=i||1!=n))t.before=t.before.replace(f("[*]{"+n+"}$",""),""),t.after=t.after.replace(f("^[*]{"+n+"}",""),"");else if(!t.selection&&a){t.after=t.after.replace(/^([*_]*)/,""),t.before=t.before.replace(/(\s?)$/,"");var s=f.$1;t.before=t.before+a+s}else{t.selection||a||(t.selection=r);var l=1>=n?"*":"**";t.before=t.before+l,t.after=l+t.after}},T.stripLinkDefs=function(t,e){return t=t.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(t,n,r,o,a){return e[n]=t.replace(/\s*$/,""),o?(e[n]=t.replace(/["(](.+?)[")]$/,""),o+a):""})},T.addLinkDef=function(t,e){var n=0,r={};t.before=this.stripLinkDefs(t.before,r),t.selection=this.stripLinkDefs(t.selection,r),t.after=this.stripLinkDefs(t.after,r);var o="",a=/(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g,i=function(t){n++,t=t.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+n+"]:"),o+="\n"+t},s=function(t,e,o,l,c,u){return o=o.replace(a,s),r[c]?(i(r[c]),e+o+l+n+u):t};t.before=t.before.replace(a,s),e?i(e):t.selection=t.selection.replace(a,s);var l=n;return t.after=t.after.replace(a,s),t.after&&(t.after=t.after.replace(/\n*$/,"")),t.after||(t.selection=t.selection.replace(/\n*$/,"")),t.after+="\n\n"+o,l},T.doLinkOrImage=function(t,e,n){t.trimWhitespace(),t.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/);var r;if(!(t.endTag.length>1&&t.startTag.length>0)){if(t.selection=t.startTag+t.selection+t.endTag,t.startTag=t.endTag="",/\n\n/.test(t.selection))return this.addLinkDef(t,null),void 0;var o=this,a=function(a){if(r.parentNode&&r.parentNode.removeChild(r),null!==a){t.selection=(" "+t.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g,"$1\\").substr(1);var i=" [999]: "+l(a),s=o.addLinkDef(t,i);t.startTag=n?"![":"[",t.endTag="]["+s+"]",t.selection||(t.selection=n?"enter image description here":"enter link description here")}e()};return r=d.createBackground(),n?this.hooks.insertImageDialog(a)||d.prompt(b,y,a):d.prompt(v,w,a),!0}t.startTag=t.startTag.replace(/!?\[/,""),t.endTag="",this.addLinkDef(t,null)},T.doAutoindent=function(t){var e=this;t.before=t.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n"),t.before=t.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n"),t.before=t.before.replace(/(\n|^)[ \t]+\n$/,"\n\n"),/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(t.before)&&e.doList&&e.doList(t),/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(t.before)&&e.doBlockquote&&e.doBlockquote(t),/(\n|^)(\t|[ ]{4,}).*\n$/.test(t.before)&&e.doCode&&e.doCode(t)},T.doBlockquote=function(t){t.selection=t.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(e,n,r,o){return t.before+=n,t.after=o+t.after,r}),t.before=t.before.replace(/(>[ \t]*)$/,function(e,n){return t.selection=n+t.selection,""}),t.selection=t.selection.replace(/^(\s|>)+$/,""),t.selection=t.selection||"Blockquote";var e,n="",r="";if(t.before){for(var o=t.before.replace(/\n$/,"").split("\n"),a=!1,i=0;o.length>i;i++){var s=!1;e=o[i],a=a&&e.length>0,/^>/.test(e)?(s=!0,!a&&e.length>1&&(a=!0)):s=/^[ \t]*$/.test(e)?!0:a,s?n+=e+"\n":(r+=n+e,n="\n")}/(^|\n)>/.test(n)||(r+=n,n="")}t.startTag=n,t.before=r,t.after&&(t.after=t.after.replace(/^\n?/,"\n")),t.after=t.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(e){return t.endTag=e,""});var l=function(e){var n=e?"> ":"";t.startTag&&(t.startTag=t.startTag.replace(/\n((>|\s)*)\n$/,function(t,e){return"\n"+e.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"})),t.endTag&&(t.endTag=t.endTag.replace(/^\n((>|\s)*)\n/,function(t,e){return"\n"+e.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"}))};/^(?![ ]{0,3}>)/m.test(t.selection)?(this.wrap(t,g.lineLength-2),t.selection=t.selection.replace(/^/gm,"> "),l(!0),t.skipLines()):(t.selection=t.selection.replace(/^[ ]{0,3}> ?/gm,""),this.unwrap(t),l(!1),!/^(\n|^)[ ]{0,3}>/.test(t.selection)&&t.startTag&&(t.startTag=t.startTag.replace(/\n{0,2}$/,"\n\n")),!/(\n|^)[ ]{0,3}>.*$/.test(t.selection)&&t.endTag&&(t.endTag=t.endTag.replace(/^\n{0,2}/,"\n\n"))),t.selection=this.hooks.postBlockquoteCreation(t.selection),/\n/.test(t.selection)||(t.selection=t.selection.replace(/^(> *)/,function(e,n){return t.startTag+=n,""}))},T.doCode=function(t){var e=/\S[ ]*$/.test(t.before),n=/^[ ]*\S/.test(t.after);if(!n&&!e||/\n/.test(t.selection)){t.before=t.before.replace(/[ ]{4}$/,function(e){return t.selection=e+t.selection,""});var r=1,o=1;/\n(\t|[ ]{4,}).*\n$/.test(t.before)&&(r=0),/^\n(\t|[ ]{4,})/.test(t.after)&&(o=0),t.skipLines(r,o),t.selection?t.selection=/^[ ]{0,3}\S/m.test(t.selection)?t.selection.replace(/^/gm,"    "):t.selection.replace(/^[ ]{4}/gm,""):(t.startTag="    ",t.selection="enter code here")}else t.trimWhitespace(),t.findTags(/`/,/`/),t.startTag||t.endTag?t.endTag&&!t.startTag?(t.before+=t.endTag,t.endTag=""):t.startTag=t.endTag="":(t.startTag=t.endTag="`",t.selection||(t.selection="enter code here"))},T.doList=function(t,e,n){var r=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/,o=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/,a="-",i=1,s=function(){var t;return n?(t=" "+i+". ",i++):t=" "+a+" ",t},l=function(t){return void 0===n&&(n=/^\s*\d/.test(t)),t=t.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(){return s()})};if(t.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null),!t.before||/\n$/.test(t.before)||/^\n/.test(t.startTag)||(t.before+=t.startTag,t.startTag=""),t.startTag){var c=/\d+[.]/.test(t.startTag);if(t.startTag="",t.selection=t.selection.replace(/\n[ ]{4}/g,"\n"),this.unwrap(t),t.skipLines(),c&&(t.after=t.after.replace(o,l)),n==c)return}var u=1;t.before=t.before.replace(r,function(t){return/^\s*([*+-])/.test(t)&&(a=f.$1),u=/[^\n]\n\n[^\n]/.test(t)?1:0,l(t)}),t.selection||(t.selection="List item");var d=s(),p=1;t.after=t.after.replace(o,function(t){return p=/[^\n]\n\n[^\n]/.test(t)?1:0,l(t)}),t.trimWhitespace(!0),t.skipLines(u,p,!0),t.startTag=d;var h=d.replace(/./g," ");this.wrap(t,g.lineLength-h.length),t.selection=t.selection.replace(/\n/g,"\n"+h)},T.doHeading=function(t){if(t.selection=t.selection.replace(/\s+/g," "),t.selection=t.selection.replace(/(^\s+|\s+$)/g,""),!t.selection)return t.startTag="## ",t.selection="Heading",t.endTag=" ##",void 0;var e=0;t.findTags(/#+[ ]*/,/[ ]*#+/),/#+/.test(t.startTag)&&(e=f.lastMatch.length),t.startTag=t.endTag="",t.findTags(null,/\s?(-+|=+)/),/=+/.test(t.endTag)&&(e=1),/-+/.test(t.endTag)&&(e=2),t.startTag=t.endTag="",t.skipLines(1,1);var n=0==e?2:e-1;if(n>0){var r=n>=2?"-":"=",o=t.selection.length;for(o>g.lineLength&&(o=g.lineLength),t.endTag="\n";o--;)t.endTag+=r}},T.doHorizontalRule=function(t){t.startTag="----------\n",t.selection="",t.skipLines(2,1,!0)}}();var o=function(){"use strict";function t(t,e){var n=Object.create(t);return n.method="PUT",void 0!==e&&(n.isNew=e),n}function e(t){var e=Object.create(t);return e.method="DELETE",e}var n="/rooms/",r={};return{prefix:n,markdown:{read:function(t,e){var o=t.id;r[o]?setTimeout(function(){e(r[o])},0):$.getJSON(n+"data/markdown",{id:o},function(n){function a(t){r[o]=t,e(t)}if(null===n){var i="===============================================";a(t.name+"\n"+(t.name&&i.substr(0,t.name.length)||i.substr(0,o.length))+"\n\nThere is no description for this "+t.type+", why not consider adding one?")}else a(n)})},update:function(e,o,a){r[e]=o,$.post(n+"data/markdown",t({id:e,content:o}),a)}},navigation:{create:function(e,r){$.post(n+"data/navigation",t(e,!0),r)},read:function(t){$.getJSON(n+"data/navigation",t)},update:function(e,r,o,a){$.post(n+"data/navigation",t({id:e,name:r,value:o},!1),a)},del:function(t,r){$.post(n+"data/navigation",e({id:t}),r)}},allocation:{update:function(e,r,o,a){$.post(n+"data/allocations",t({roomid:e,year:r,crsid:o}),a)}},choosingOrder:{read:function(t){$.getJSON(n+"data/choosingorder",t)}}}}(),a=function(){function t(){this._callbacks={}}function e(t,e){return Object.create({year:function(){var t=new Date;return(t.getMonth()>6?t.getFullYear():t.getFullYear()-1)+e}(),defaultText:t})}function n(t){for(var e=0;t.allocations.length>e;e++){var n=t.allocations[e];n.year=parseInt(n.year,10),n.timestamp=parseInt(n.timestamp,10),(void 0===l.timestamp||n.timestamp>l.timestamp)&&(l.timestamp=n.timestamp);var r=n.roomid,o=n.crsid,a=n.year,i={};a===c.allocationsThisYear.year?i=c.allocationsThisYear:a===c.allocationsNextYear.year&&(i=c.allocationsNextYear),i[r]=o}return c}function r(){var t=[];for(var e in c.defaultAllocations())c.defaultAllocations().hasOwnProperty(e)&&t.push({roomid:e,crsid:c.defaultAllocations()[e],year:c.defaultAllocations().year});return{allocations:t}}t.prototype.on=function(t,e){return(this._callbacks[t]=this._callbacks[t]||[]).push(e),this},t.prototype.off=function(t,e){var n=this._callbacks[t];if(!n)return this;if(1==arguments.length)return delete this._callbacks[t],this;var r=n.indexOf(e._off||e);return~r&&n.splice(r,1),this},t.prototype.emit=function(t){var e=[].slice.call(arguments,1),n=this._callbacks[t];if(n){n=n.slice(0);for(var r=0,o=n.length;o>r;++r)n[r].apply(this,e)}return this},t.prototype.once=function(t,e){function n(){r.off(t,n),e.apply(this,arguments)}var r=this;return e._off=n,this.on(t,n),this};var i=new t,s=function(){function t(t){var n;for(n=0;e.length>n;n++)e[n](t)}var e=[],n=!1,r=function(t){n=t},a=function(){return!1};return $(function(){function e(){if("undefined"!=typeof io){var e="http://rcsa-rooms-stream.herokuapp.com/",o=io.connect(e),i=o.socket,s=!1;r=function(t){n=t||n,n&&i.connected&&o.emit("auth",n,function(){s=!0})},o.on("authRequired",function(){r()}),o.on("message",function(e){t(JSON.parse(e))});var l=0;setInterval(function(){a()?(t({}),l=0):(l++,l>600+Math.floor(60*Math.random())&&(l=0,location.reload(!1)))},1e3),i.on("reconnect_failed",function(){setTimeout(function(){window.location.reload(!1)},500)}),a=function(){return i.connected&&s}}}var o=document.createElement("script");o.type="text/javascript",o.src="http://rcsa-rooms-stream.herokuapp.com/socket.io/socket.io.js",o.async=!1,o.onreadystatechange=o.onload=function(){var t=o.readyState;e.done||t&&!/loaded|complete/.test(t)||(e.done=!0,e())},document.body.appendChild(o)}),function(){function e(){function n(n,o){var s=new Date;n.auth&&n.auth.notificationKey&&r(n.auth.notificationKey),t(n),setTimeout(e,(a()?24e4:o)+10*(s.getTime()-i.getTime()))}var i=new Date;$.ajax({url:o.prefix+"data/stream",dataType:"json",data:l,success:function(t){n(t,5e3)},error:function(t,e){n(e,12e4)}})}e()}(),function(t){return e.push(t),function(){e=e.filter(function(t){})}}}(),l={};s(function(t){i.emit("raw",t)});var c={allocationsThisYear:e("Unknown",0),allocationsNextYear:e("Available",1),defaultAllocations:function(){return 0===$("#isThisYears:checked").length?this.allocationsNextYear:this.allocationsThisYear},loaded:!1};return i.on("raw",function(t){if(t.auth&&(l.auth=t.auth.isAuthenticated,i.emit("auth",t.auth)),t.allocations){c.loaded=!0,i.emit("allocations",n(t));for(var e=0;t.allocations.length>e;e++)i.emit("allocation",t.allocations[e]),c.defaultAllocations().year===parseInt(t.allocations[e].year,10)&&i.emit("default-year-allocation",t.allocations[e])}}),i.onAllocationChanged=function(t){for(var e=r().allocations,n=0;e.length>n;n++)t(e[n]);return i.on("default-year-allocation",t),function(){a.off("default-year-allocation",t)}},i.getAllocations=function(t){c.loaded?t(c):i.once("allocations",t)},i}(),i=function(){"use strict";function t(t,n){return 2===arguments.length?Mustache.to_html(e[t],n):1===arguments.length?function(n){return Mustache.to_html(e[t],n)}:void 0}return n.core.route.prototype.toOld=n.core.route.prototype.to,n.core.route.prototype.to=function(t,e){return void 0===e&&(e=[]),this.toOld(function(){function n(t){return o.params[t]}var r=new Date,o=this;t.apply(this,e.map(n));var a=new Date;"undefined"!=typeof console&&(console.info===void 0?console.log(window.location.hash+" run in "+(a.getTime()-r.getTime())+"ms"):console.info(window.location.hash+" run in "+(a.getTime()-r.getTime())+"ms"))})},n.refresh=function(){n.routes.current=null,n.dispatch(location.hash)},Array.prototype.groupBy=function(t){function e(e){return function(n){return t(e,n[0])}}return this.reduce(function(t,n){return t.some(e(n))?t.filter(e(n))[0].push(n):t.push([n]),t},[])},Array.prototype.first=function(t){for(var e=0;this.length>e;e++)if(t(this[e]))return this[e]},String.prototype.format=function(){var t=arguments;return this.replace(/{(\d+)}/g,function(e,n){return t[n]!==void 0?t[n]:e})},String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},{template:t}}(),s=function(){function t(t){void 0!==t.isAuthenticated&&(l=t.isAuthenticated),o=new Date,i||s.clearStatus()}function e(t){var e=""+t,n="00";return n.substr(e.length)+e}function n(){return e(o.getHours())+":"+e(o.getMinutes())+":"+e(o.getSeconds())}function r(){return"../user/raven/login/"+c.encode("rooms/"+location.hash)+"/"+c.encode("rooms/")}var o,i,l=void 0;setTimeout(function(){a.on("auth",t),a.on("raw",t),$("#status").hover(function(){l||$("#status a").attr("href",r())}),$("#login").hover(function(){l||$("#loginButton").attr("href",r())})},0);var c=function(){function t(t){t=t.replace(/\r\n/g,"\n");for(var e="",n=0;t.length>n;n++){var r=t.charCodeAt(n);128>r?e+=String.fromCharCode(r):r>127&&2048>r?(e+=String.fromCharCode(192|r>>6),e+=String.fromCharCode(128|63&r)):(e+=String.fromCharCode(224|r>>12),e+=String.fromCharCode(128|63&r>>6),e+=String.fromCharCode(128|63&r))}return e}function e(t){for(var e="",n=0,r=c1=c2=0;t.length>n;)r=t.charCodeAt(n),128>r?(e+=String.fromCharCode(r),n++):r>191&&224>r?(c2=t.charCodeAt(n+1),e+=String.fromCharCode((31&r)<<6|63&c2),n+=2):(c2=t.charCodeAt(n+1),c3=t.charCodeAt(n+2),e+=String.fromCharCode((15&r)<<12|(63&c2)<<6|63&c3),n+=3);return e}var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(e){var r,o,a,i,s,l,c,u="",d=0;for(e=t(e);e.length>d;)r=e.charCodeAt(d++),o=e.charCodeAt(d++),a=e.charCodeAt(d++),i=r>>2,s=(3&r)<<4|o>>4,l=(15&o)<<2|a>>6,c=63&a,isNaN(o)?l=c=64:isNaN(a)&&(c=64),u=u+n.charAt(i)+n.charAt(s)+n.charAt(l)+n.charAt(c);return u},decode:function(t){var r,o,a,i,s,l,c,u="",d=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");t.length>d;)i=n.indexOf(t.charAt(d++)),s=n.indexOf(t.charAt(d++)),l=n.indexOf(t.charAt(d++)),c=n.indexOf(t.charAt(d++)),r=i<<2|s>>4,o=(15&s)<<4|l>>2,a=(3&l)<<6|c,u+=String.fromCharCode(r),64!=l&&(u+=String.fromCharCode(o)),64!=c&&(u+=String.fromCharCode(a));return u=e(u)}}}();return{uri:r,setStatus:function(t,e){return i=!0,$("#status").html(t),void 0!==e&&setTimeout(this.clearStatus,e),this},clearStatus:function(){return i=!1,l?$("#status").html("last updated "+n()):$("#status").html('<a  class="login" href="'+r()+'">Log in to view allocations and edit data</a>'),this}}}();s.clearStatus(),Function.prototype.curry=function(t){var e=this,n=function(){if(t>arguments.length){var r=Array.prototype.slice,o=r.apply(arguments);return function(){return n.apply(this,o.concat(r.apply(arguments)))}}return e.apply(this,arguments)};return n};var l=function(){var t=function(t,e,n){return"function"==typeof n[t]?n[t]()===e:n[t]===e}.curry(3),e=function(t,e,n){return e[t]===n[t]}.curry(3);return{and:function(){var t=arguments;return function(e,n,r){for(var n=0;t.length>n;n++)if(!t[n](e,n,r))return!1;return!0}},or:function(){var t=arguments;return function(e,n,r){for(var n=0;t.length>n;n++)if(t[n](e,n,r))return!0;return!1}},not:function(t,e,n,r){return!t(e,n,r)}.curry(2),sameFloor:e("floor"),sameStaircase:e("parentid"),parentIs:t("parentid"),idIs:t("id"),typeIs:t("type"),roomidIs:t("roomid"),isPermanentlyUnavailable:t("rentband",0),equals:function(t,e){return t===e}.curry(2)}}(),c=function(){function t(t,e){return t>e?1:e>t?-1:0}function e(t,e){return+t-+e}function n(e,n){return function(e,n){return"Root"===e&&"Root"!==n?-1:"Root"!==e&&"Root"===n?1:t(e,n)}(e.parentid,n.parentid)}function r(t,n){return e(t.weight,n.weight)}function o(t,n){return void 0!==t.floor&&void 0!==n.floor?e(t.floor,n.floor):void 0}function a(n,r){var o=n.id.match(s),a=r.id.match(s);return o&&a&&o.length>0&&a.length>0?e(parseInt(o[0],10),parseInt(a[0],10))||e(n.id.length,r.id.length)||t(n.id,r.id):t(n.id,r.id)}function i(){var t=arguments;return function(e,n){for(var r=0;t.length>r;r++){var o=t[r](e,n);if(o)return o}}}var s=/[0-9]+/g;return{numberComparer:e,navigationItemComparer:i(n,r,o,a)}}(),u=function(){"use strict";return{selectNavigationItem:function(t){return d.navigationItem(t)},selectFloor:function(t){return new d.Floor(t)}}}();(function(t){t.fn.toTable=function(e){return this.find("td").each(function(){var n=t(this),r=n.find("input,select");0!==r.length&&(n.dblclick(function(){var t=n.find("div");t.hide(),r.show().focus()}),r.blur(function(){var t=n.find("div"),o=n.attr("itemprop"),a=n.parents("tr").attr("itemid"),i="number"===r.attr("type")?Number(r.hide().val()):r.hide().val(),s=t.html();s!==i?e(a,o,i)===!1?(r.val(s),t.show()):t.show().html(i):t.show()}))}),this}})(jQuery);var d=function(){function t(t){var e,n=["bathroomsharing","rentband","floor","isgardenfacing"];for(e=0;n.length>e;e++)null===t[n[e]]&&delete t[n[e]];var r=["bathroomsharing","rentband","floor"];for(e=0;r.length>e;e++)t[r[e]]&&(t[r[e]]=parseInt(t[r[e]],10))}function e(t){return function(){return this.type===t}}function n(){var t="#/";return""!==this.parentid&&"Root"!==this.parentid&&(t+=this.parentid+"/"),""!==this.id&&(t+=this.id+"/"),t}function r(){return"Root"===this.parentid&&f.SelectedStaircaseID===this.id||this.parentid===f.SelectedStaircaseID&&f.SelectedRoomID===this.id}function o(){switch(this.bathroomsharing){case 0:return"";case 1:return"Ensuite";default:return"Shared between "+this.bathroomsharing+" people"}}function a(){return 1===this.isgardenfacing?"Garden Facing":0===this.isgardenfacing?"Courtyard Facing":"unknown"}function i(){return f.allocationsNextYear[this.id]||""}function s(){return this.name.replace(/<br\/>/g," ")}var l=function(){var t=["Ground Floor","First Floor","Second Floor","Third Floor","Fourth Floor","Fith Floor","Sixth Floor"];return t[-1]="Basement",function(){return t[this.floor]||"Floor "+this.floor}}(),c=function(){var t=["Unavailable to Students","Value","Standard","Standard Plus","Best"];return function(){return t[this.rentband]||this.rentband}}();return isStaircase=e("staircase"),isRoom=e("room"),isPage=e("page"),isSpecial=e("special"),{navigationItem:function(e){t(e);var u=Object.create(e);return u.weight=e.weight||0,u.isStaircase=isStaircase,u.isRoom=isRoom,u.isPage=isPage,u.isSpecial=isSpecial,u.url=n,u.selected=r,u.bathroom=o,u.floorDescription=l,u.gardenFacing=a,u.allocation=i,u.nameSingleLine=s,u.rentBandDescription=c,u},Floor:function(t){this.Name=t[0].floorDescription(),this.Rooms=t}}}(),p={};p.allocationEdit=function(){var t=function(t,e){var n=t[e.id];return{id:e.id,name:e.nameSingleLine(),allocation:n||""}}.curry(2),e=function(e,n){var r=n[0].parentid,o=Object.create(f.Navigation.first(l.idIs(r)));return o.rooms=n.map(t(e)),o}.curry(2),r=!1;return $("#isThisYears").click(function(){r&&n.refresh()}),{enter:function(t){r=!0,p.markdown.loadMarkdown(t,!0),$("#templated").html(),a.getAllocations(function(t){var n=t.defaultAllocations(),r=n.year,a=f.Navigation.filter(l.typeIs("room")).filter(l.not(l.isPermanentlyUnavailable)).groupBy(l.sameStaircase).map(e(n)).sort(c.navigationItemComparer);$("#templated").html(i.template("allocationEdit",{staircases:a,year:r})).find("form").submit(function(t){var e=t.currentTarget.allocation.value,n=$(t.currentTarget);return n.find("input").removeClass("validationError"),n.attr("data-old-allocation")!==e&&(n.attr("data-old-allocation",e),s.setStatus("Updating Allocation"),o.allocation.update(n.attr("data-roomid"),r,e,function(t){s.setStatus(t,5e3)})),!1}).find("input").blur(function(t){$(t.target).submit()})}),a.onAllocationChanged(function(t){var e=t.roomid;$('form[data-roomid="'+e+'"] input').val(t.crsid)}),f.reloadNavigation("","allocationEdit")},exit:function(){r=!1}}}(),p.importFile=function(){function t(t){for(var e,n=t.target.files,r=0;e=n[r];r++){var a=new FileReader;a.onload=function(){return function(t){function e(t){o.markdown.update(a.markdown[t].id,a.markdown[t].content,function(){a.markdown.length>t+1?e(t+1):n(0)})}function n(t){o.allocation.update(a.allocation[t].roomid,a.allocation[t].year,a.allocation[t].crsid,function(){a.allocation.length>t+1?n(t+1):alert("done")})}var r=t.target.result,a=$.parseJSON(r);e(0)}}(n[r]),a.readAsText(n[r])}}return window.File&&window.FileReader&&window.FileList&&window.Blob?($("#templated").html('<input type="file" id="files" name="files" />'),document.getElementById("files").addEventListener("change",t,!1),void 0):(alert("The File APIs are not fully supported in this browser."),void 0)},p.markdown=function(){function e(t,e){if(t&&t.type.match(/image.*/)){var n=new FormData;n.append("image",t),n.append("key",a);var r=new XMLHttpRequest;r.open("POST","http://api.imgur.com/2/upload.json"),r.onload=function(){var t=JSON.parse(r.responseText).upload.links;e(t.original)},r.send(n)}}function n(){function t(){$("#busy").dialog({autoOpen:!0,closeOnEscape:!1,draggable:!1,resizable:!1,modal:!0,height:80,width:180})}function e(){$("#busy").dialog("close")}function n(t,e){$("#"+t).dialog({autoOpen:!0,closeOnEscape:!0,minWidth:500,modal:!0,buttons:{OK:function(){$(this).dialog("close"),e($(this))},Cancel:function(){$(this).dialog("close"),e(null)}},close:function(){$(this).hide(),e(!1)}})}return $(".dialog").dialog({autoOpen:!1}),{showBusy:t,hideBusy:e,showDialog:n}}var a="e0b484465d77858ebaf6b3c7c1732909",l=function(){var e=r.getSanitizingConverter();return e.hooks.chain("plainLinkText",function(t){return t.replace(/^https?:\/\//,"")}),e.hooks.chain("preConversion",function(t){return t.replace(/\(#(.*)\)/g,"(http://hashurl.com/$1)").replace(/]: #(.*)/g,"]: http://hashurl.com/$1")}),e.hooks.chain("postConversion",function(t){return t.replace(/http:\/\/hashurl.com\//g,"#")}),e.hooks.chain("preConversion",function(t){return t.replace(/((\r\n|\n|\r)\/\/.*$)|(^\/\/.*(\r\n|\n|\r))/gm,"")}),e.hooks.chain("postConversion",function(t){return t.replace(/\[allocation:([^\]]*)\]/g,'<span class="allocationDisplay" data-roomid="$1"></span>').replace(/\[allocation-current:([^\]]*)\]/g,'<span class="allocationDisplay" data-roomid="$1" data-year="current"></span>').replace(/\[allocation-next:([^\]]*)\]/g,'<span class="allocationDisplay" data-roomid="$1" data-year="next"></span>')}),e.hooks.chain("postConversion",function(t){return t.replace(/\/>\[(left|right|middle|top|bottom)\]/g,'align="$1" />')}),e.hooks.chain("postConversion",function(t){return t.replace(/<\/h1>/g,"</h1><hr>")}),function(){var n=t();e.hooks.chain("preConversion",function(t){function e(t,e){return"<tr><"+e+">"+t.replace(/^\||\|$/g,"").replace(/\|/g,"</"+e+"><"+e+">")+"</"+e+"></tr>"}var r=t.replace(/(\r\n|\n|\r)/gm,"\n").replace(/^([^\n]*\|[^\n]*)\n[\s-\|]*-[\s-\|]*$/gm,function(t,n){return e(n,"th")}).replace(/^(.*)\|(.*)$/gm,function(t){return e(t,"td")}).replace(/^\n((?:<tr>[^\n]*\n)+)$/gm,function(t,e){return n.enqueue("<table>"+e+"</table>"),"\n\n[table]\n\n"});return r}),e.hooks.chain("postConversion",function(t){return t.replace(/<p>\[table\]<\/p>/gm,n.dequeue)})}(),e}(),c=function(){var t=new r.Editor(l),o=n();t.hooks.chain("onPreviewRefresh",function(){f.refreshAllocationsDisplay()}),t.hooks.set("insertImageDialog",function(t){return o.showDialog("getImage",function(n){if(n===!1)t(null);else{var r=n.find("input")[0].files;1!==r.length?t(null):(o.showBusy(),e(r[0],function(e){o.hideBusy(),t(e)}))}}),!0}),t.run()};return{loadMarkdown:function(t){t.isSpecial()||t.isPage()||!1,o.markdown.read(t,function(e){$("#markdown").html(Mustache.to_html('{{{Content}}}<a id="editLink" href="#/{{ID}}/edit/">edit</a>',{ID:t.id,Content:l.makeHtml(e)})),f.refreshAllocationsDisplay(),f.checkAuth(t)})},edit:function(t){o.markdown.read(t,function(e){$("#markdown").html(i.template("markdownEdit",{Content:e})).find("form").submit(function(n){var r=n.target,a=r.content.value;return a!==e?(s.setStatus("Saving description"),o.markdown.update(t.id,a,function(){history.go(-1),s.setStatus("Description saved",2e3)}),!1):(s.setStatus("Description not changed",2e3),history.go(-1),!1)}),c()})}}}(),p.navigationTableEdit=function(){function t(t){return!isNaN(Number(t))&&Number(t)>=0}function e(t){return!isNaN(Number(t))&&Number(t)>-5&&20>Number(t)}function n(t){return!isNaN(Number(t))&&0!==Number(t)}function r(t){return alert(t),!1}function a(n,o){if(o&&f.Navigation.some(l.idIs(n.id)))return r("There is already an item with this ID");if(n.id===n.parentid)return r("An item can't be its own parent");if("Root"!==n.parentid&&!f.Navigation.some(l.idIs(n.parentid)))return r('The parent ID must either be the ID of an existing item or "Root"');if("room"===n.type){if(!t(n.bathroomsharing))return r("A room must have a number greater than 0 to specify how many people the bathroom is shared with.");if(!e(n.floor))return r("A room must have a sensible floor number.")}else{if(void 0!==n.bathroomsharing)return r("Only a room can have a value for Bathroom Sharing.");if(void 0!==n.rentband)return r("Only a room can have a value for Rent Band.");if(void 0!==n.floor)return r("Only a room can have a value for Floor.");if(void 0!==n.isgardenfacing)return r("Only a room can have a value for Garde Facing.")}return!0}function u(t,e){for(var n=f.Navigation.filter(l.parentIs(t)),r=0;n.length>r;r++)n[r].parentid=e}function h(t){var e=t.target,r={id:e.id.value,name:e.name.value,parentid:e.parentid.value,type:e.type.value};return n(e.weight.value)&&(r.weight=e.weight.value),"room"===r.type&&(r.bathroomsharing=e.bathroomsharing.value,r.rentband=e.rentband.value,r.floor=e.floor.value),a(r,!0)&&(f.Navigation.push(d.navigationItem(r)),f.Navigation=f.Navigation.sort(c.navigationItemComparer),s.setStatus("Saving..."),o.navigation.create(r,function(){s.setStatus("Saved",2e3)}),p.navigationTableEdit(d.navigationItem(r))),!1}function g(t,e,n){var r=f.Navigation.filter(l.idIs(t))[0],i=Object.create(r);return i[e]=n,a(i,"id"===e)?(r[e]=n,"id"===e&&u(t,n),s.setStatus("Saving..."),o.navigation.update(t,e,n,function(){s.setStatus("Saved",2e3)}),void 0):!1}var m;return function(t){if("navigationTableEdit"===t.id)m=t;else{var e=t;t=m}p.markdown.loadMarkdown(t,!0);var n=e?Object.create(e):{};n.Navigation=f.Navigation,$("#templated").html(i.template("navigationTableEdit",n)).toTable(g).find("form").submit(h),$("#templated button").click(function(t){if(confirm("Are you sure you want to delete?")){var e=$(t.target).parents("tr").attr("itemid"),n=f.Navigation.indexOf(f.Navigation.filter(l.idIs(e))[0]);f.Navigation.splice(n,1),p.navigationTableEdit(),s.setStatus("Deleting..."),o.navigation.del(e,function(){s.setStatus("Deleted",2e3)})}}),f.reloadNavigation("","navigationTableEdit")}}(),p.projector=function(){var t,e=function(t){var e=Object.create(t);return e.css=0===t.rentband?"permanentlyUnavailable":"",e},r=function(t){var n=t[0].parentid,r=Object.create(f.Navigation.first(l.idIs(n)));return r.rooms=t.map(e),r},o=!1;$("#isThisYears").click(function(){o&&(p.projector.exit(),n.refresh())});var u,d=!0;return{enter:function(){function e(t){var e=t.roomid;""===t.crsid?($("#"+e).addClass("available").removeClass("unavailable").fadeIn(),d||$(".allocationDisplayPart").hide()):($("#"+e).removeClass("available").addClass("unavailable").find(".allocationDisplayPart").show(),d||$("#"+e).fadeOut(5e3))}if(f.checkAuth({id:"projector"}),o=!0,f.authorization.updated&&!f.authorization.isAuthenticated&&!f.authorization.allocationsView){var n=s.uri();return location.hash="#/",window.location.href=n,void 0}t=$("#colmask").html(),$("#header").html('<input type="checkbox" '+(d?"":"checked")+">Hide Unavailable Rooms").find("input").click(function(){d=0===$("#header :checkbox:checked").length,d?($(".allocationDisplayPart").fadeIn(5e3),$(".unavailable:not(.permanentlyUnavailable)").fadeIn(5e3)):($(".allocationDisplayPart").fadeOut(2e3),$(".unavailable").fadeOut(2e3))});var p=f.Navigation.filter(l.typeIs("room")).groupBy(l.sameStaircase).map(r).sort(c.navigationItemComparer);$("#page").removeClass("page").addClass("projector"),$("body").removeClass("background"),$("#colmask").html(i.template("projector",{staircases:p})),$("footer").hide(),f.refreshAllocationsDisplay(),u=a.onAllocationChanged(e),d||($(".allocationDisplayPart").hide(),$(".unavailable").hide())},exit:function(){o=!1,u(),$("#page").addClass("page").removeClass("projector"),$("body").addClass("background"),$("#colmask").html(t),$("footer").show(),$("#header").html("")}}}(),p.loadRoom=function(t){p.markdown.loadMarkdown(t),$("#templated").html(i.template("room",t)),f.refreshAllocationsDisplay()},p.loadStaircase=function(t){"use strict";p.markdown.loadMarkdown(t);var e=f.Navigation.filter(l.and(l.parentIs(t.id),l.typeIs("room"))),n=e.groupBy(l.sameFloor).map(u.selectFloor);$("#templated").html(i.template("staircase",{Floors:n})),f.refreshAllocationsDisplay()},p.staticPage=function(t){p.markdown.loadMarkdown(t,!0),$("#templated").html("")},p.home=function(){p.staticPage("")},p.choosingOrderEdit=function(t){p.markdown.loadMarkdown(t,!0),o.choosingOrder.read(function(t){for(var e={firstYears:[],secondYears:[],thirdYears:[]},n=new Date,r=n.getFullYear(),o=0;t.length>o;o++){var a=t[o],s=a.yeargroup-r;1===s?e.firstYears.push(a):2===s?e.secondYears.push(a):3===s&&e.thirdYears.push(a)}$("#templated").html(i.template("choosingOrderEdit",e)),$("#sortable").sortable(),$("#tabs").tabs()
})};var f=function(t){"use strict";function e(){function t(t,r){var o=r.exit||function(){};n.map(t).to(function(){var t=d.Navigation.first(l.idIs(this.params[r.id]||r.id))||r.item,n=this.params[r.parentIDs]||r.parentIDs;(!n||t.parentid===n||r.parentIDs.some&&r.parentIDs.some(l.equals(t.parentid)))&&e(t,r.edit,r.enter)}).exit(o)}function e(t,e,n){if(!t)return!1;if(f.checkAuth(t)!==!1)if("Root"===t.parentid?d.reloadNavigation(t.id):d.reloadNavigation(t.parentid,t.id),e)p.markdown.edit(t);else switch(t.type){case"staircase":return p.loadStaircase(t);case"page":return p.staticPage(t);case"room":return p.loadRoom(t);case"special":return n(t);default:return!1}}n.map("#/projector/").to(p.projector.enter).exit(p.projector.exit),n.map("#/import/").to(p.importFile),t("#/allocationEdit/",{id:"allocationEdit",enter:p.allocationEdit.enter,exit:p.allocationEdit.exit}),t("#/navigationTableEdit/",{id:"navigationTableEdit",enter:p.navigationTableEdit,item:{id:"navigationTableEdit",type:"special"}}),t("#/choosingOrderEdit/",{id:"choosingOrderEdit",enter:p.choosingOrderEdit}),t("#//edit/",{id:"",parentIDs:"",edit:!0}),t("#/:id/edit/",{id:"id",edit:!0}),t("#/",{id:"",parentIDs:""}),t("#/:sid/",{id:"sid",parentIDs:["","Root"]}),t("#/:sid/:rid/",{id:"rid",parentIDs:"sid"})}function r(){var e=!1;(function(e){o.navigation.read(function(n){d.Navigation=n.map(u.selectNavigationItem).sort(c.navigationItemComparer),t(e)})})(function(){t("body").removeClass("loading").addClass("background"),t("#page").fadeIn(),n.listen(),e=!0,t("#isThisYears").click(d.refreshAllocationsDisplay)})}var d={SelectedStaircaseID:"",SelectedRoomID:"",Navigation:[],RentBands:[],authorization:!1};return t(function(){function e(){return r&&n(r),f}function n(e){r=e,t(".allocationDisplay").each(function(){var n=t(this),r={};r="current"===n.attr("data-year")?e.allocationsThisYear:"next"===n.attr("data-year")?e.allocationsNextYear:e.defaultAllocations(),n.html(r[n.attr("data-roomid")]||r.defaultText)})}var r=!1;a.on("allocations",n),d.refreshAllocationsDisplay=e}),t(function(){function e(t){return r=t,d.authorization&&n(d.authorization,!0),f}function n(e,n){if(d.authorization=e,n!==!0&&d.reloadNavigation(),e.isAuthenticated?t("#login").hide():t("#login").show(),r&&(e.markdownEdit&&(r.isRoom&&r.isRoom()||r.isStaircase&&r.isStaircase()||f.authorization.markdownSpecialEdit)?t("#editLink").show():t("#editLink").hide(),e.isAuthenticated===!1&&("#/projector/"===location.hash||"#/navigationTableEdit/"===location.hash||"#/allocationEdit/"===location.hash||/\/edit\/$/.test(location.hash)))){var o=s.uri();return location.hash="#/",window.location.href=o,void 0}}var r;a.on("auth",n),d.checkAuth=e}),d.reloadNavigation=function(e,n){function r(t){return"navigationTableEdit"===t.id?d.authorization&&d.authorization.navigationEdit:"allocationEdit"===t.id?d.authorization&&d.authorization.allocationsEdit:!0}arguments.length>0&&(d.SelectedStaircaseID=e,d.SelectedRoomID=n);var o=d.Navigation.filter(r),a=o.filter(l.parentIs("Root"));t("#staircases").html(i.template("NavigationList",{Links:a}));var s=o.filter(l.parentIs(d.SelectedStaircaseID));t("#rooms").html(i.template("NavigationList",{Links:s}))},n.root("#/"),e(),r(),d}(jQuery)})();