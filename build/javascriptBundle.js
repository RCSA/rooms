(function(){function e(t,n,r){var o=e.resolve(t),i=e.modules[o];if(null==o)throw r=r||t,n=n||"root",Error('failed to require "'+r+'" from "'+n+'"');return i.exports||(i.exports={},i.client=i.component=!0,i.call(this,i,i.exports,e.relative(o))),i.exports}e.modules={},e.aliases={},e.resolve=function(t){var n=t,r=t+".js",o=t+".json",i=t+"/index.js",a=t+"/index.json";return e.modules[r]&&r||e.modules[o]&&o||e.modules[i]&&i||e.modules[a]&&a||e.modules[n]&&n||e.aliases[i]},e.normalize=function(e,t){var n=[];if("."!=t.charAt(0))return t;e=e.split("/"),t=t.split("/");for(var r=0;t.length>r;++r)".."==t[r]?e.pop():"."!=t[r]&&""!=t[r]&&n.push(t[r]);return e.concat(n).join("/")},e.register=function(t,n){e.modules[t]=n},e.alias=function(t,n){var r=e.modules[t];if(!r)throw Error('failed to alias "'+t+'", it does not exist');e.aliases[n]=t},e.relative=function(t){function n(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}function r(n){var o=n;return n=r.resolve(n),e(n,t,o)}var o=e.normalize(t,"..");return r.resolve=function(r){if("."!=r.charAt(0)){var i=t.split("/"),a=n(i,"deps")+1;return a||(a=0),r=i.slice(0,a+1).join("/")+"/deps/"+r}return e.normalize(o,r)},r.exists=function(t){return!!e.modules[r.resolve(t)]},r},e.register("ForbesLindesay-curry/index.js",function(e){function t(e){return Array.prototype.slice.apply(e)}function n(e){function n(){if(e.length>arguments.length){var r=t(arguments);return function(){return n.apply(this,r.concat(t(arguments)))}}return e.apply(this,arguments)}return n}e.exports=n}),e.register("ForbesLindesay-queue/index.js",function(e){function t(e){function t(){if(0===r.length)for(var e=n.length,t=0;e>t;t++)r.push(n.pop());return o}var n=[],r=[],o=e||{};return o.enqueue=function(e){n.push(e)},o.dequeue=function(){if(t(),!r.length)throw Error("Can't dequeue from an empty queue");return r.pop()},o.peek=function(){if(t(),!r.length)throw Error("Can't peek from an empty queue");return r[r.length-1]},o.isEmpty=function(){return 0===n.length&&0===r.length},o}e.exports=t,t(e.exports)}),e.register("component-to-function/index.js",function(e){function t(e){switch({}.toString.call(e)){case"[object Function]":return e;case"[object String]":return o(e);case"[object RegExp]":return r(e);default:return n(e)}}function n(e){return function(t){return e===t}}function r(e){return function(t){return e.test(t)}}function o(e){return/^ *\W+/.test(e)?Function("_","return _ "+e):Function("_","return _."+e)}e.exports=t}),e.register("component-type/index.js",function(e){var t=Object.prototype.toString;e.exports=function(e){switch(t.call(e)){case"[object Function]":return"function";case"[object Date]":return"date";case"[object RegExp]":return"regexp";case"[object Arguments]":return"arguments";case"[object Array]":return"array"}return null===e?"null":void 0===e?"undefined":e===Object(e)?"object":typeof e}}),e.register("ForbesLindesay-to-bool-function/index.js",function(e,t,n){function r(e,t){if(2==arguments.length)return e=a(e),t=r(t),function(){return t(e.apply(this,arguments))};t=e;var n=!1;try{switch(s(t)){case"regexp":n=o(t);break;case"string":case"function":n=a(t);break;case"object":n=i(t)}}catch(l){}return function(e){return e===t||n&&n.apply(this,arguments)}}function o(e){return function(t){return e.test(t)}}function i(e){var t=Object.keys(e).map(function(t){return r(t,e[t])});return function(e){for(var n=0;t.length>n;n++)if(!t[n](e))return!1;return!0}}var a=n("to-function"),s=n("type");e.exports=r}),e.register("ForbesLindesay-utf8-encode/index.js",function(e){function t(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;e.length>n;n++){var r=e.charCodeAt(n);128>r?t+=String.fromCharCode(r):r>127&&2048>r?(t+=String.fromCharCode(192|r>>6),t+=String.fromCharCode(128|63&r)):(t+=String.fromCharCode(224|r>>12),t+=String.fromCharCode(128|63&r>>6),t+=String.fromCharCode(128|63&r))}return t}e.exports=t}),e.register("ForbesLindesay-base64-encode/index.js",function(e,t,n){function r(e){var t,n,r,a,s,l,c,u="",d=0;for(e=o(e);e.length>d;)t=e.charCodeAt(d++),n=e.charCodeAt(d++),r=e.charCodeAt(d++),a=t>>2,s=(3&t)<<4|n>>4,l=(15&n)<<2|r>>6,c=63&r,isNaN(n)?l=c=64:isNaN(r)&&(c=64),u=u+i.charAt(a)+i.charAt(s)+i.charAt(l)+i.charAt(c);return u}var o=n("utf8-encode"),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";e.exports=r}),e.register("ForbesLindesay-promises-a/index.js",function(e){(function(){function t(){function e(e){d.length?(p=!0,d.shift()(e||!1)):p=!1}function n(n,r){function o(t){function o(){var t;try{t=a(l)}catch(n){return i.reject(n),e()}i.fulfill(t),e(!0)}var a=u?n:r;"function"==typeof a?t?o():setTimeout(o,0):u?(i.fulfill(l),e(t)):(i.reject(l),e(t))}var i=t();return d.push(o),c&&!p&&e(),i.promise}function r(e,t){var n=f;(e||t)&&(n=n.then(e,t)),n.then(null,function(e){setTimeout(function(){throw e},0)})}function o(t,n){if(!c){if(t&&"object"==typeof n&&"function"==typeof n.then)return n.then(i,a),void 0;c=!0,u=t,l=n,e()}}function i(e){o(!0,e)}function a(e){o(!1,e)}function s(){return u?l:f}var l,c=!1,u=!1,d=[],p=!1,f={then:n,valueOf:s,done:r};return{promise:f,fulfill:i,reject:a}}e!==void 0&&e.exports!==void 0?e.exports=t:window.promise=t})()}),e.register("ForbesLindesay-imgur/index.js",function(e,t,n){function r(e){function t(t){var n=o();i(n.promise);try{if(!t){var r=Error("You must supply an image to upload.");throw r.code="MissingFile",r}if(!t.type.match(/image.*/)){var r=Error("Invalid file type, imgur only accepts images.");throw r.code="InvalidFileType",r}var a=new FormData;a.append("image",t),a.append("key",e);var s=new XMLHttpRequest;s.open("POST","http://api.imgur.com/2/upload.json"),s.onload=function(){try{n.fulfill(JSON.parse(s.responseText).upload)}catch(e){n.reject(e)}},s.onerror=n.reject,s.upload.onprogress=function(e){e.perecent=100*(e.loaded/e.total),n.promise.emit("progress",e)},n.promise.abort=function(){s.abort();var e=Error("Image upload aborted");e.code="UploadAborted",n.reject(e)},s.send(a)}catch(l){n.reject(l)}return n.promise}return{upload:t}}var o=n("promises-a"),i=n("emitter");e.exports=r}),e.register("component-find/index.js",function(e,t,n){function r(e){return function(t){for(var n in e)if(t[n]!=e[n])return!1;return!0}}var o=n("to-function");e.exports=function(e,t){"function"!=typeof t&&(t=Object(t)===t?r(t):o(t));for(var n=0,i=e.length;i>n;++n)if(t(e[n],n))return e[n]}}),e.register("component-group-by/index.js",function(e,t,n){var r=n("to-function");e.exports=function(e,t){var n,o={};t=r(t);for(var i=0;e.length>i;++i)n=t(e[i],i),o[n]=o[n]||[],o[n].push(e[i]);return o}}),e.register("component-emitter/index.js",function(e){function t(e){return e?n(e):void 0}function n(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}e.exports=t,t.prototype.on=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){r.off(e,n),t.apply(this,arguments)}var r=this;return this._callbacks=this._callbacks||{},t._off=n,this.on(e,n),this},t.prototype.off=function(e,t){this._callbacks=this._callbacks||{};var n=this._callbacks[e];if(!n)return this;if(1==arguments.length)return delete this._callbacks[e],this;var r=n.indexOf(t._off||t);return~r&&n.splice(r,1),this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n){n=n.slice(0);for(var r=0,o=n.length;o>r;++r)n[r].apply(this,t)}return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}}),e.register("rooms/index.js",function(e,t,n){function r(){function e(e,r){var o=r.exit||function(){};m.map(e).to(function(){var e=f(t.Navigation,y("id",this.params[r.id]||r.id))||r.item,o=this.params[r.parentIDs]||r.parentIDs;(!o||e.parentid===o||r.parentIDs.some&&r.parentIDs.some(function(t){return t==e.parentid}))&&n(e,r.edit,r.enter)}).exit(o)}function n(e,n,r){if(!e)return!1;if(t.checkAuth(e)!==!1)if("Root"===e.parentid?t.reloadNavigation(e.id):t.reloadNavigation(e.parentid,e.id),n)u(e);else switch(e.type){case"staircase":return i(e);case"page":return o(e);case"room":return a(e);case"special":return r(e);default:return!1}}m.map("#/projector/").to(s.enter).exit(s.exit),e("#/allocationEdit/",{id:"allocationEdit",enter:l.enter,exit:l.exit}),e("#/navigationTableEdit/",{id:"navigationTableEdit",enter:c,item:{id:"navigationTableEdit",type:"special"}}),e("#//edit/",{id:"",parentIDs:"",edit:!0}),e("#/:id/edit/",{id:"id",edit:!0}),e("#/",{id:"",parentIDs:""}),e("#/:sid/",{id:"sid",parentIDs:["","Root"]}),e("#/:sid/:rid/",{id:"rid",parentIDs:"sid"})}var o=n("./views/static-page"),i=n("./views/staircase"),a=n("./views/room"),s=n("./views/projector"),l=n("./views/allocation-edit"),c=n("./views/navigation-table-edit"),u=n("./markdown/edit-markdown"),d=n("./model"),p=n("./helpers/navigation-item-order"),f=n("find"),h=n("./helpers/status-display").uri,g=n("./template"),m=n("./libraries/path"),v=n("./server"),b=n("./stream"),y=n("to-bool-function"),w=jQuery;t.SelectedStaircaseID="",t.SelectedRoomID="",t.Navigation=[],t.authorization=!1,w(function(){function e(){return r&&n(r),t}function n(e){r=e,w(".allocationDisplay").each(function(){var t=w(this),n={};n="current"===t.attr("data-year")?e.allocationsThisYear:"next"===t.attr("data-year")?e.allocationsNextYear:e.defaultAllocations(),t.html(n[t.attr("data-roomid")]||n.defaultText)})}var r=!1;b.on("allocations",n),t.refreshAllocationsDisplay=e}),w(function(){function e(e){return r=e,t.authorization&&n(t.authorization,!0),t}function n(e,n){if(t.authorization=e,n!==!0&&t.reloadNavigation(),e.isAuthenticated?w("#login").hide():w("#login").show(),r&&(e.markdownEdit&&(r.isRoom&&r.isRoom()||r.isStaircase&&r.isStaircase()||t.authorization.markdownSpecialEdit)?w("#editLink").show():w("#editLink").hide(),e.isAuthenticated===!1&&("#/projector/"===location.hash||"#/navigationTableEdit/"===location.hash||"#/allocationEdit/"===location.hash||/\/edit\/$/.test(location.hash)))){var o=h();return location.hash="#/",window.location.href=o,void 0}}var r;b.on("auth",n),t.checkAuth=e}),t.reloadNavigation=function(e,n){function r(e){return"navigationTableEdit"===e.id?t.authorization&&t.authorization.navigationEdit:"allocationEdit"===e.id?t.authorization&&t.authorization.allocationsEdit:!0}arguments.length>0&&(t.SelectedStaircaseID=e,t.SelectedRoomID=n);var o=t.Navigation.filter(r),i=o.filter(y("parentid","Root"));w("#staircases").html(g("NavigationList",{Links:i}));var a=o.filter(y("parentid",t.SelectedStaircaseID));w("#rooms").html(g("NavigationList",{Links:a}))},m.root("#/"),r(),v.navigation.read(function(e){t.Navigation=e.map(d.navigationItem).sort(p),w(function(){w("body").removeClass("loading").addClass("background"),w("#page").fadeIn(),m.listen(),w("#isThisYears").click(t.refreshAllocationsDisplay)})})}),e.register("rooms/model.js",function(e,t,n){function r(e){var t,n=["bathroomsharing","rentband","floor","isgardenfacing"];for(t=0;n.length>t;t++)null===e[n[t]]&&delete e[n[t]];var r=["bathroomsharing","rentband","floor"];for(t=0;r.length>t;t++)e[r[t]]&&(e[r[t]]=parseInt(e[r[t]],10))}function o(e){return function(){return this.type===e}}function i(){var e="#/";return""!==this.parentid&&"Root"!==this.parentid&&(e+=this.parentid+"/"),""!==this.id&&(e+=this.id+"/"),e}function a(){return"Root"===this.parentid&&d.SelectedStaircaseID===this.id||this.parentid===d.SelectedStaircaseID&&d.SelectedRoomID===this.id}function s(){switch(this.bathroomsharing){case 0:return"";case 1:return"Ensuite";default:return"Shared between "+this.bathroomsharing+" people"}}function l(){return 1===this.isgardenfacing?"Garden Facing":0===this.isgardenfacing?"Courtyard Facing":"unknown"}function c(){return d.allocationsNextYear[this.id]||""}function u(){return this.name.replace(/<br\/>/g," ")}var d=n("./"),p=function(){var e=["Ground Floor","First Floor","Second Floor","Third Floor","Fourth Floor","Fith Floor","Sixth Floor"];return e[-1]="Basement",function(){return e[this.floor]||"Floor "+this.floor}}(),f=function(){var e=["Unavailable to Students","Value","Standard","Standard Plus","Best"];return function(){return e[this.rentband]||this.rentband}}();isStaircase=o("staircase"),isRoom=o("room"),isPage=o("page"),isSpecial=o("special"),e.exports.navigationItem=function(e){r(e);var t=Object.create(e);return t.weight=e.weight||0,t.isStaircase=isStaircase,t.isRoom=isRoom,t.isPage=isPage,t.isSpecial=isSpecial,t.url=i,t.selected=a,t.bathroom=s,t.floorDescription=p,t.gardenFacing=l,t.allocation=c,t.nameSingleLine=u,t.rentBandDescription=f,t}}),e.register("rooms/views/static-page.js",function(e,t,n){function r(e){o(e,!0),document.getElementById("templated").innerHTML=""}var o=n("../markdown/load-markdown");e.exports=r}),e.register("rooms/views/staircase.js",function(e,t,n){function r(e){return Object.keys(e).map(function(t){return{Name:e[t][0].floorDescription(),Rooms:e[t]}})}var o=n("../"),i=n("../markdown/load-markdown"),a=n("../template"),s=n("group-by"),l=n("to-bool-function");e.exports=function(e){i(e);var t=o.Navigation.filter(l("parentid",e.id)).filter(l("type","room")),n=r(s(t,"floor"));document.getElementById("templated").innerHTML=a("staircase",{Floors:n}),o.refreshAllocationsDisplay()}}),e.register("rooms/views/room.js",function(e,t,n){var r=n("../"),o=n("../markdown/load-markdown"),i=n("../template");e.exports=function(e){o(e),$("#templated").html(i("room",e)),r.refreshAllocationsDisplay()}}),e.register("rooms/views/projector.js",function(e,t,n){function r(e){return Object.keys(e).map(function(t){var n=Object.create(a(i.Navigation,f("id",t)));return n.rooms=e[t].filter(function(e){return 0!==e.rentband}),n})}var o,i=n("../"),a=n("find"),s=n("../helpers/status-display").uri,l=n("../template"),c=n("../helpers/navigation-item-order"),u=n("../libraries/path").refresh,d=n("group-by"),p=n("../stream"),f=n("to-bool-function"),h=!1;$("#isThisYears").click(function(){h&&(t.exit(),u())});var g,m=!0;t.enter=function(){function e(e){var t=e.roomid;""===e.crsid?($("#"+t).addClass("available").removeClass("unavailable").fadeIn(),m||$(".allocationDisplayPart").hide()):($("#"+t).removeClass("available").addClass("unavailable").find(".allocationDisplayPart").show(),m||$("#"+t).fadeOut(5e3))}if(i.checkAuth({id:"projector"}),h=!0,i.authorization.updated&&!i.authorization.isAuthenticated&&!i.authorization.allocationsView){var t=s();return location.hash="#/",window.location.href=t,void 0}o=$("#colmask").html(),$("#header").html('<input type="checkbox" '+(m?"":"checked")+">Hide Unavailable Rooms").find("input").click(function(){m=0===$("#header :checkbox:checked").length,m?($(".allocationDisplayPart").fadeIn(5e3),$(".unavailable:not(.permanentlyUnavailable)").fadeIn(5e3)):($(".allocationDisplayPart").fadeOut(2e3),$(".unavailable").fadeOut(2e3))});var n=r(d(i.Navigation.filter(f("type","room")),"parentid")).sort(c);$("#page").removeClass("page").addClass("projector"),$("body").removeClass("background"),$("#colmask").html(l("projector",{staircases:n})),$("footer").hide(),i.refreshAllocationsDisplay(),g=p.onAllocationChanged(e),m||($(".allocationDisplayPart").hide(),$(".unavailable").hide())},t.exit=function(){h=!1,g(),$("#page").addClass("page").removeClass("projector"),$("body").addClass("background"),$("#colmask").html(o),$("footer").show(),$("#header").html("")}}),e.register("rooms/views/navigation-table-edit.js",function(e,t,n){function r(e){return!isNaN(Number(e))&&Number(e)>=0}function o(e){return!isNaN(Number(e))&&Number(e)>-5&&20>Number(e)}function i(e){return!isNaN(Number(e))&&0!==Number(e)}function a(e){return alert(e),!1}function s(e,t){if(t&&p.Navigation.some(w("id",e.id)))return a("There is already an item with this ID");if(e.id===e.parentid)return a("An item can't be its own parent");if("Root"!==e.parentid&&!p.Navigation.some(w("id",e.parentid)))return a('The parent ID must either be the ID of an existing item or "Root"');if("room"===e.type){if(!r(e.bathroomsharing))return a("A room must have a number greater than 0 to specify how many people the bathroom is shared with.");if(!o(e.floor))return a("A room must have a sensible floor number.")}else{if(void 0!==e.bathroomsharing)return a("Only a room can have a value for Bathroom Sharing.");if(void 0!==e.rentband)return a("Only a room can have a value for Rent Band.");if(void 0!==e.floor)return a("Only a room can have a value for Floor.");if(void 0!==e.isgardenfacing)return a("Only a room can have a value for Garde Facing.")}return!0}function l(e,t){for(var n=p.Navigation.filter(w("parentid",e)),r=0;n.length>r;r++)n[r].parentid=t}function c(e){var t=e.target,n={id:t.id.value,name:t.name.value,parentid:t.parentid.value,type:t.type.value};return i(t.weight.value)&&(n.weight=t.weight.value),"room"===n.type&&(n.bathroomsharing=t.bathroomsharing.value,n.rentband=t.rentband.value,n.floor=t.floor.value),s(n,!0)&&(p.Navigation.push(f.navigationItem(n)),p.Navigation=p.Navigation.sort(b),m("Saving..."),y.navigation.create(n,function(){m("Saved",2e3)}),view.navigationTableEdit(f.navigationItem(n))),!1}function u(e,t,n){var r=p.Navigation.filter(w("id",e))[0],o=Object.create(r);return o[t]=n,s(o,"id"===t)?(r[t]=n,"id"===t&&l(e,n),m("Saving..."),y.navigation.update(e,t,n,function(){m("Saved",2e3)}),void 0):!1}var d,p=n("../"),f=n("../model"),h=n("../markdown/load-markdown"),g=n("../helpers/table"),m=n("../helpers/status-display").setStatus,v=n("../template"),b=n("../helpers/navigation-item-order"),y=n("../server"),w=n("to-bool-function");e.exports=function(e){if("navigationTableEdit"===e.id)d=e;else{var t=e;e=d}h(e,!0);var n=t?Object.create(t):{};n.Navigation=p.Navigation,$("#templated").html(v("navigationTableEdit",n)).find("form").submit(c),g("#templated",u),$("#templated button").click(function(e){if(confirm("Are you sure you want to delete?")){var t=$(e.target).parents("tr").attr("itemid"),n=p.Navigation.indexOf(p.Navigation.filter(w("id",t))[0]);p.Navigation.splice(n,1),view.navigationTableEdit(),m("Deleting..."),y.navigation.del(t,function(){m("Deleted",2e3)})}}),p.reloadNavigation("","navigationTableEdit")}}),e.register("rooms/views/allocation-edit.js",function(e,t,n){function r(e,t){return Object.keys(t).map(function(n){var r=Object.create(s(o.Navigation,g("id",n)));return r.rooms=t[n].map(m(e)),r})}var o=n("../"),i=n("../helpers/status-display").setStatus,a=n("curry"),s=n("find"),l=n("../template"),c=n("../helpers/navigation-item-order"),u=n("../markdown/load-markdown"),d=n("../libraries/path").refresh,p=n("group-by"),f=n("../server"),h=n("../stream"),g=n("to-bool-function"),m=a(function(e,t){var n=e[t.id];return{id:t.id,name:t.nameSingleLine(),allocation:n||""}}),v=!1;$("#isThisYears").click(function(){v&&d()}),t.enter=function(e){v=!0,u(e,!0),$("#templated").html(),h.getAllocations(function(e){var t=e.defaultAllocations(),n=t.year,a=r(t,p(o.Navigation.filter(g("type","room")).filter(function(e){return 0!==e.rentband}),"parentid")).sort(c);$("#templated").html(l("allocationEdit",{staircases:a,year:n})).find("form").submit(function(e){var t=e.currentTarget.allocation.value,r=$(e.currentTarget);return r.find("input").removeClass("validationError"),r.attr("data-old-allocation")!==t&&(r.attr("data-old-allocation",t),i("Updating Allocation"),f.allocation.update(r.attr("data-roomid"),n,t,function(e){i(e,5e3)})),!1}).find("input").blur(function(e){$(e.target).submit()})}),h.onAllocationChanged(function(e){var t=e.roomid;$('form[data-roomid="'+t+'"] input').val(e.crsid)})},t.exit=function(){v=!1}}),e.register("rooms/markdown/load-markdown.js",function(e,t,n){var r=n("../"),o=n("./converter"),i=n("../server");e.exports=function(e){i.markdown.read(e,function(t){$("#markdown").html(Mustache.to_html('{{{Content}}}<a id="editLink" href="#/{{ID}}/edit/">edit</a>',{ID:e.id,Content:o.makeHtml(t)})),r.refreshAllocationsDisplay(),r.checkAuth(e)})}}),e.register("rooms/markdown/edit-markdown.js",function(e,t,n){function r(){function e(){$("#busy").dialog({autoOpen:!0,closeOnEscape:!1,draggable:!1,resizable:!1,modal:!0,height:80,width:180})}function t(){$("#busy").dialog("close")}function n(e,t){$("#"+e).dialog({autoOpen:!0,closeOnEscape:!0,minWidth:500,modal:!0,buttons:{OK:function(){$(this).dialog("close"),t($(this))},Cancel:function(){$(this).dialog("close"),t(null)}},close:function(){$(this).hide(),t(!1)}})}return $(".dialog").dialog({autoOpen:!1}),{showBusy:e,hideBusy:t,showDialog:n}}function o(){var e=new l.Editor(a),t=r();e.hooks.chain("onPreviewRefresh",function(){i.refreshAllocationsDisplay()}),e.hooks.set("insertImageDialog",function(e){return t.showDialog("getImage",function(n){n===!1?e(null):(t.showBusy(),f(n.find("input")[0].files[0]).done(function(n){t.hideBusy(),e(n.links.original)},function(n){if(t.hideBusy(),e(null),"InvalidFileType"===n.code)alert("The file you provided was not a valid image.");else{if("MissingFile"!==n.code)throw n;alert("You didn't provide an image to upload")}}))}),!0}),e.run()}var i=n("../"),a=n("./converter"),s=n("../helpers/status-display").setStatus,l=n("../libraries/pagedown.js"),c=n("../template"),u=n("../server"),d=n("imgur"),p="e0b484465d77858ebaf6b3c7c1732909",f=d(p).upload;e.exports=function(e){u.markdown.read(e,function(t){$("#markdown").html(c("markdownEdit",{Content:t})).find("form").submit(function(n){var r=n.target,o=r.content.value;return o!==t?(s("Saving description"),u.markdown.update(e.id,o,function(){history.go(-1),s("Description saved",2e3)}),!1):(s("Description not changed",2e3),history.go(-1),!1)}),o()})}}),e.register("rooms/markdown/converter.js",function(e,t,n){var r=n("../libraries/pagedown.js"),o=e.exports=r.getSanitizingConverter();o.hooks.chain("preConversion",function(e){return e.replace(/\(#(.*)\)/g,"(http://hashurl.com/$1)").replace(/]: #(.*)/g,"]: http://hashurl.com/$1")}),o.hooks.chain("postConversion",function(e){return e.replace(/http:\/\/hashurl.com\//g,"#")}),o.hooks.chain("preConversion",function(e){return e.replace(/((\r\n|\n|\r)\/\/.*$)|(^\/\/.*(\r\n|\n|\r))/gm,"")}),o.hooks.chain("postConversion",function(e){return e.replace(/\[allocation:([^\]]*)\]/g,'<span class="allocationDisplay" data-roomid="$1"></span>').replace(/\[allocation-current:([^\]]*)\]/g,'<span class="allocationDisplay" data-roomid="$1" data-year="current"></span>').replace(/\[allocation-next:([^\]]*)\]/g,'<span class="allocationDisplay" data-roomid="$1" data-year="next"></span>')}),o.hooks.chain("postConversion",function(e){return e.replace(/\/>\[(left|right|middle|top|bottom)\]/g,'align="$1" />')}),o.hooks.chain("postConversion",function(e){return e.replace(/<\/h1>/g,"</h1><hr>")})}),e.register("rooms/helpers/table.js",function(e){function t(e,t){n(e).find("td").each(function(){var e=n(this),r=e.find("input,select");0!==r.length&&(e.dblclick(function(){var t=e.find("div");t.hide(),r.show().focus()}),r.blur(function(){var n=e.find("div"),o=e.attr("itemprop"),i=e.parents("tr").attr("itemid"),a="number"===r.attr("type")?Number(r.hide().val()):r.hide().val(),s=n.html();s!==a?t(i,o,a)===!1?(r.val(s),n.show()):n.show().html(a):n.show()}))})}var n=jQuery;e.exports=t}),e.register("rooms/helpers/navigation-item-order.js",function(e){function t(e,t){return e>t?1:t>e?-1:0}function n(e,t){return+e-+t}function r(e,n){return function(e,n){return"Root"===e&&"Root"!==n?-1:"Root"!==e&&"Root"===n?1:t(e,n)}(e.parentid,n.parentid)}function o(e,t){return n(e.weight,t.weight)}function i(e,t){return void 0!==e.floor&&void 0!==t.floor?n(e.floor,t.floor):void 0}function a(e,r){var o=e.id.match(l),i=r.id.match(l);return o&&i&&o.length>0&&i.length>0?n(parseInt(o[0],10),parseInt(i[0],10))||n(e.id.length,r.id.length)||t(e.id,r.id):t(e.id,r.id)}function s(){var e=arguments;return function(t,n){for(var r=0;e.length>r;r++){var o=e[r](t,n);if(o)return o}}}var l=/[0-9]+/g;e.exports=s(r,o,i,a)}),e.register("rooms/helpers/status-display.js",function(e,t,n){function r(e){void 0!==e.isAuthenticated&&(f=e.isAuthenticated),c=new Date,u||l()}function o(e){var t=""+e,n="00";return n.substr(t.length)+t}function i(){return o(c.getHours())+":"+o(c.getMinutes())+":"+o(c.getSeconds())}function a(){return"../user/raven/login/"+d("rooms/"+location.hash)+"/"+d("rooms/")}function s(e,t){return u=!0,$("#status").html(e),void 0!==t&&setTimeout(this.clearStatus,t),this}function l(){return u=!1,f?$("#status").html("last updated "+i()):$("#status").html('<a  class="login" href="'+a()+'">Log in to view allocations and edit data</a>'),this}var c,u,d=n("base64-encode"),p=n("../stream"),f=void 0;t.uri=a,t.setStatus=s,t.clearStatus=l,l(),p.on("auth",r),p.on("raw",r),$("#status").hover(function(){f||$("#status a").attr("href",a())}),$("#login").hover(function(){f||$("#loginButton").attr("href",a())})}),e.register("rooms/libraries/pagedown.js",function(e,t,n){t=!1,n=null;var r;r="object"==typeof t&&"function"==typeof n?t:{},function(){function e(e){return e}function t(){return!1}function n(){}function o(){}n.prototype={chain:function(t,n){var r=this[t];if(!r)throw Error("unknown hook "+t);this[t]=r===e?n:function(e){return n(r(e))}},set:function(e,t){if(!this[e])throw Error("unknown hook "+e);this[e]=t},addNoop:function(t){this[t]=e},addFalse:function(e){this[e]=t}},r.HookCollection=n,o.prototype={set:function(e,t){this["s_"+e]=t},get:function(e){return this["s_"+e]}},r.Converter=function(){function e(e){return e=e.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,function(e,t,n,r,o,i){return t=t.toLowerCase(),A.set(t,T(n)),o?r:(i&&R.set(t,i.replace(/"/g,"&quot;")),"")})}function t(e){return e=e.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,r),e=e.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,r),e=e.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,r),e=e.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g,r),e=e.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,r)}function r(e,t){var n=t;return n=n.replace(/^\n+/,""),n=n.replace(/\n+$/g,""),n="\n\n~K"+(_.push(n)-1)+"K\n\n"}function i(e,n){e=f(e);var r="<hr />\n";return e=e.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,r),e=e.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,r),e=e.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,r),e=h(e),e=m(e),e=x(e),e=t(e),e=k(e,n)}function a(e){return e=b(e),e=s(e),e=$(e),e=u(e),e=l(e),e=C(e),e=e.replace(/~P/g,"://"),e=T(e),e=w(e),e=e.replace(/  +\n/g," <br>\n")}function s(e){var t=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;return e=e.replace(t,function(e){var t=e.replace(/(.)<\/?code>(?=.)/g,"$1`");return t=D(t,"!"==e.charAt(1)?"\\`*_/":"\\`*_")})}function l(e){return e=e.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,c),e=e.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,c),e=e.replace(/(\[([^\[\]]+)\])()()()()()/g,c)}function c(e,t,n,r,o,i,a,s){void 0==s&&(s="");var l=t,c=n.replace(/:\/\//g,"~P"),u=r.toLowerCase(),p=o,f=s;if(""==p)if(""==u&&(u=c.toLowerCase().replace(/ ?\n/g," ")),p="#"+u,void 0!=A.get(u))p=A.get(u),void 0!=R.get(u)&&(f=R.get(u));else{if(!(l.search(/\(\s*\)$/m)>-1))return l;p=""}p=L(p),p=D(p,"*_");var h='<a href="'+p+'"';return""!=f&&(f=d(f),f=D(f,"*_"),h+=' title="'+f+'"'),h+=">"+c+"</a>"}function u(e){return e=e.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,p),e=e.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,p)}function d(e){return e.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function p(e,t,n,r,o,i,a,s){var l=t,c=n,u=r.toLowerCase(),p=o,f=s;if(f||(f=""),""==p){if(""==u&&(u=c.toLowerCase().replace(/ ?\n/g," ")),p="#"+u,void 0==A.get(u))return l;p=A.get(u),void 0!=R.get(u)&&(f=R.get(u))}c=D(d(c),"*_[]()"),p=D(p,"*_");var h='<img src="'+p+'" alt="'+c+'"';return f=d(f),f=D(f,"*_"),h+=' title="'+f+'"',h+=" />"}function f(e){return e=e.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(e,t){return"<h1>"+a(t)+"</h1>\n\n"}),e=e.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(e,t){return"<h2>"+a(t)+"</h2>\n\n"}),e=e.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(e,t,n){var r=t.length;return"<h"+r+">"+a(n)+"</h"+r+">\n\n"})}function h(e){e+="~0";var t=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return F?e=e.replace(t,function(e,t,n){var r=t,o=n.search(/[*+-]/g)>-1?"ul":"ol",i=g(r,o);return i=i.replace(/\s+$/,""),i="<"+o+">"+i+"</"+o+">\n"}):(t=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,e=e.replace(t,function(e,t,n,r){var o=t,i=n,a=r.search(/[*+-]/g)>-1?"ul":"ol",s=g(i,a);return s=o+"<"+a+">\n"+s+"</"+a+">\n"})),e=e.replace(/~0/,"")}function g(e,t){F++,e=e.replace(/\n{2,}$/,"\n"),e+="~0";var n=B[t],r=RegExp("(^[ \\t]*)(?:"+n+")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1("+n+")[ \\t]+))","gm"),o=!1;return e=e.replace(r,function(e,t,n){var r=/\n\n$/.test(n),s=r||n.search(/\n{2,}/)>-1;return s||o?n=i(E(n),!0):(n=h(E(n)),n=n.replace(/\n$/,""),n=a(n)),o=r,"<li>"+n+"</li>\n"}),e=e.replace(/~0/g,""),F--,e}function m(e){return e+="~0",e=e.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(e,t,n){var r=t,o=n;return r=y(E(r)),r=j(r),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,""),r="<pre><code>"+r+"\n</code></pre>","\n\n"+r+"\n\n"+o}),e=e.replace(/~0/,"")}function v(e){return e=e.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(_.push(e)-1)+"K\n\n"}function b(e){return e=e.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(e,t,n,r){return r=r.replace(/^([ \t]*)/g,""),r=r.replace(/[ \t]*$/g,""),r=y(r),r=r.replace(/:\/\//g,"~P"),t+"<code>"+r+"</code>"})}function y(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=D(e,"*_{}[]\\",!1)}function w(e){return e=e.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,"$1<strong>$3</strong>$4"),e=e.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,"$1<em>$3</em>$4")}function x(e){return e=e.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(e,t){var n=t;return n=n.replace(/^[ \t]*>[ \t]?/gm,"~0"),n=n.replace(/~0/g,""),n=n.replace(/^[ \t]+$/gm,""),n=i(n),n=n.replace(/(^|\n)/g,"$1  "),n=n.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(e,t){var n=t;return n=n.replace(/^  /gm,"~0"),n=n.replace(/~0/g,"")}),v("<blockquote>\n"+n+"\n</blockquote>")})}function k(e,t){e=e.replace(/^\n+/g,""),e=e.replace(/\n+$/g,"");for(var n=e.split(/\n{2,}/g),r=[],o=/~K(\d+)K/,i=n.length,s=0;i>s;s++){var l=n[s];o.test(l)?r.push(l):/\S/.test(l)&&(l=a(l),l=l.replace(/^([ \t]*)/g,"<p>"),l+="</p>",r.push(l))}if(!t){i=r.length;for(var s=0;i>s;s++)for(var c=!0;c;)c=!1,r[s]=r[s].replace(/~K(\d+)K/g,function(e,t){return c=!0,_[t]})}return r.join("\n\n")}function T(e){return e=e.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),e=e.replace(/<(?![a-z\/?\$!])/gi,"&lt;")}function $(e){return e=e.replace(/\\(\\)/g,N),e=e.replace(/\\([`*_{}\[\]()>#+-.!])/g,N)}function C(e){e=e.replace(/(^|\s)(https?|ftp)(:\/\/[-A-Z0-9+&@#\/%?=~_|\[\]\(\)!:,\.;]*[-A-Z0-9+&@#\/%=~_|\[\]])($|\W)/gi,"$1<$2$3>$4");var t=function(e,t){return'<a href="'+t+'">'+I.plainLinkText(t)+"</a>"};return e=e.replace(/<((https?|ftp):[^'">\s]+)>/gi,t)}function S(e){return e=e.replace(/~E(\d+)E/g,function(e,t){var n=parseInt(t);return String.fromCharCode(n)})}function E(e){return e=e.replace(/^(\t|[ ]{1,4})/gm,"~0"),e=e.replace(/~0/g,"")}function j(e){if(!/\t/.test(e))return e;var t,n=["    ","   ","  "," "],r=0;return e.replace(/[\n\t]/g,function(e,o){return"\n"===e?(r=o+1,e):(t=(o-r)%4,r=o+1,n[t])})}function L(e){if(!e)return"";var t=e.length;return e.replace(O,function(n,r){return"~D"==n?"%24":":"!=n||r!=t-1&&!/[0-9\/]/.test(e.charAt(r+1))?"%"+n.charCodeAt(0).toString(16):":"})}function D(e,t,n){var r="(["+t.replace(/([\[\]\\])/g,"\\$1")+"])";
n&&(r="\\\\"+r);var o=RegExp(r,"g");return e=e.replace(o,N)}function N(e,t){var n=t.charCodeAt(0);return"~E"+n+"E"}var I=this.hooks=new n;I.addNoop("plainLinkText"),I.addNoop("preConversion"),I.addNoop("postConversion");var A,R,_,F;this.makeHtml=function(n){if(A)throw Error("Recursive call to converter.makeHtml");return A=new o,R=new o,_=[],F=0,n=I.preConversion(n),n=n.replace(/~/g,"~T"),n=n.replace(/\$/g,"~D"),n=n.replace(/\r\n/g,"\n"),n=n.replace(/\r/g,"\n"),n="\n\n"+n+"\n\n",n=j(n),n=n.replace(/^[ \t]+$/gm,""),n=t(n),n=e(n),n=i(n),n=S(n),n=n.replace(/~D/g,"$$"),n=n.replace(/~T/g,"~"),n=I.postConversion(n),_=R=A=null,n};var B={ol:"\\d+[.]",ul:"[*+-]"},O=/(?:["'*()[\]:]|~D)/g}}(),function(){function e(e){return e.replace(/<[^><]*>?/gi,o)}function o(e){return e.match(l)||e.match(c)||e.match(u)?e:e.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")}function i(e){if(""==e)return"";var t=/<\/?\w+[^>]*(\s|$|>)/g,n=e.toLowerCase().match(t),r=(n||[]).length;if(0==r)return e;for(var o,i,a,s="<p><img><br><li><hr>",l=[],c=[],u=!1,d=0;r>d;d++)if(o=n[d].replace(/<\/?(\w+).*/,"$1"),!(l[d]||s.search("<"+o+">")>-1)){if(i=n[d],a=-1,!/^<\//.test(i))for(var p=d+1;r>p;p++)if(!l[p]&&n[p]=="</"+o+">"){a=p;break}-1==a?u=c[d]=!0:l[a]=!0}if(!u)return e;var d=0;return e=e.replace(t,function(e){var t=c[d]?"":e;return d++,t})}var a,s;"object"==typeof t&&"function"==typeof n?(a=t,s=n("./Markdown.Converter").Converter):(a=r,s=a.Converter),a.getSanitizingConverter=function(t){return t=t||new s,t.hooks.chain("postConversion",e),t.hooks.chain("postConversion",i),t};var l=/^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i,c=/^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i,u=/^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i}(),function(){function e(){}function t(e){this.buttonBar=p.getElementById("wmd-button-bar"+e),this.preview=p.getElementById("wmd-preview"+e),this.input=p.getElementById("wmd-input"+e)}function n(e,t){var n,r,i,a=this,s=[],l=0,u="none",d=function(e,t){u!=e&&(u=e,t||f()),m&&"moving"==u?i=null:r=setTimeout(p,1)},p=function(e){i=new o(t,e),r=void 0};this.setCommandMode=function(){u="command",f(),r=setTimeout(p,0)},this.canUndo=function(){return l>1},this.canRedo=function(){return s[l+1]?!0:!1},this.undo=function(){a.canUndo()&&(n?(n.restore(),n=null):(s[l]=new o(t),s[--l].restore(),e&&e())),u="none",t.input.focus(),p()},this.redo=function(){a.canRedo()&&(s[++l].restore(),e&&e()),u="none",t.input.focus(),p()};var f=function(){var r=i||new o(t);return r?"moving"==u?(n||(n=r),void 0):(n&&(s[l-1].text!=n.text&&(s[l++]=n),n=null),s[l++]=r,s[l+1]=null,e&&e(),void 0):!1},h=function(e){var t=!1;if(e.ctrlKey||e.metaKey){var n=e.charCode||e.keyCode,r=String.fromCharCode(n);switch(r.toLowerCase()){case"y":a.redo(),t=!0;break;case"z":e.shiftKey?a.redo():a.undo(),t=!0}}return t?(e.preventDefault&&e.preventDefault(),window.event&&(window.event.returnValue=!1),void 0):void 0},g=function(e){if(!e.ctrlKey&&!e.metaKey){var t=e.keyCode;t>=33&&40>=t||t>=63232&&63235>=t?d("moving"):8==t||46==t||127==t?d("deleting"):13==t?d("newlines"):27==t?d("escape"):(16>t||t>20)&&91!=t&&d("typing")}},v=function(){c.addEvent(t.input,"keypress",function(e){!e.ctrlKey&&!e.metaKey||89!=e.keyCode&&90!=e.keyCode||e.preventDefault()});var e=function(){(m||i&&i.text!=t.input.value)&&void 0==r&&(u="paste",f(),p())};c.addEvent(t.input,"keydown",h),c.addEvent(t.input,"keydown",g),c.addEvent(t.input,"mousedown",function(){d("moving")}),t.input.onpaste=e,t.input.ondrop=e},b=function(){v(),p(!0),f()};b()}function o(t,n){var r=this,o=t.input;this.init=function(){c.isVisible(o)&&(n||!p.activeElement||p.activeElement===o)&&(this.setInputAreaSelectionStartEnd(),this.scrollTop=o.scrollTop,(!this.text&&o.selectionStart||0===o.selectionStart)&&(this.text=o.value))},this.setInputAreaSelection=function(){if(c.isVisible(o))if(void 0!==o.selectionStart)o.focus(),o.selectionStart=r.start,o.selectionEnd=r.end,o.scrollTop=r.scrollTop;else if(p.selection){if(p.activeElement&&p.activeElement!==o)return;o.focus();var e=o.createTextRange();e.moveStart("character",-o.value.length),e.moveEnd("character",-o.value.length),e.moveEnd("character",r.end),e.moveStart("character",r.start),e.select()}},this.setInputAreaSelectionStartEnd=function(){if(t.ieCachedRange||!o.selectionStart&&0!==o.selectionStart){if(p.selection){r.text=c.fixEolChars(o.value);var e=t.ieCachedRange||p.selection.createRange(),n=c.fixEolChars(e.text),i="",a=i+n+i;e.text=a;var s=c.fixEolChars(o.value);e.moveStart("character",-a.length),e.text=n,r.start=s.indexOf(i),r.end=s.lastIndexOf(i)-i.length;var l=r.text.length-c.fixEolChars(o.value).length;if(l){for(e.moveStart("character",-n.length);l--;)n+="\n",r.end+=1;e.text=n}t.ieCachedRange&&(r.scrollTop=t.ieCachedScrollTop),t.ieCachedRange=null,this.setInputAreaSelection()}}else r.start=o.selectionStart,r.end=o.selectionEnd},this.restore=function(){void 0!=r.text&&r.text!=o.value&&(o.value=r.text),this.setInputAreaSelection(),o.scrollTop=r.scrollTop},this.getChunks=function(){var t=new e;return t.before=c.fixEolChars(r.text.substring(0,r.start)),t.startTag="",t.selection=c.fixEolChars(r.text.substring(r.start,r.end)),t.endTag="",t.after=c.fixEolChars(r.text.substring(r.end)),t.scrollTop=r.scrollTop,t},this.setChunks=function(e){e.before=e.before+e.startTag,e.after=e.endTag+e.after,this.start=e.before.length,this.end=e.before.length+e.selection.length,this.text=e.before+e.selection+e.after,this.scrollTop=e.scrollTop},this.init()}function i(e,t,n){var r,o,i,a=3e3,s="delayed",l=function(e,t){c.addEvent(e,"input",t),e.onpaste=t,e.ondrop=t,c.addEvent(e,"keypress",t),c.addEvent(e,"keydown",t)},d=function(){var e=0;return window.innerHeight?e=window.pageYOffset:p.documentElement&&p.documentElement.scrollTop?e=p.documentElement.scrollTop:p.body&&(e=p.body.scrollTop),e},f=function(){if(t.preview){var n=t.input.value;if(!n||n!=i){i=n;var r=(new Date).getTime();n=e.makeHtml(n);var a=(new Date).getTime();o=a-r,T(n)}}},h=function(){if(r&&(clearTimeout(r),r=void 0),"manual"!==s){var e=0;"delayed"===s&&(e=o),e>a&&(e=a),r=setTimeout(f,e)}},g=function(e){return e.clientHeight>=e.scrollHeight?1:e.scrollTop/(e.scrollHeight-e.clientHeight)},v=function(){t.preview&&(t.preview.scrollTop=(t.preview.scrollHeight-t.preview.clientHeight)*g(t.preview))};this.refresh=function(e){e?(i="",f()):h()},this.processingTime=function(){return o};var b,y=!0,w=function(e){var n=t.preview,r=n.parentNode,o=n.nextSibling;r.removeChild(n),n.innerHTML=e,o?r.insertBefore(n,o):r.appendChild(n)},x=function(e){t.preview.innerHTML=e},k=function(e){if(b)return b(e);try{x(e),b=x}catch(t){b=w,b(e)}},T=function(e){var r=u.getTop(t.input)-d();if(t.preview&&(k(e),n()),v(),y)return y=!1,void 0;var o=u.getTop(t.input)-d();m?setTimeout(function(){window.scrollBy(0,o-r)},0):window.scrollBy(0,o-r)},$=function(){l(t.input,h),f(),t.preview&&(t.preview.scrollTop=0)};$()}function a(e,t,n,r,i,a,s){function l(e){if(v.focus(),e.textOp){n&&n.setCommandMode();var i=new o(t);if(!i)return;var a=i.getChunks(),s=function(){v.focus(),a&&i.setChunks(a),i.restore(),r.refresh()},l=e.textOp(a,s);l||s()}e.execute&&e.execute(n)}function u(e,n){var r="0px",o="-20px",i="-40px",a=e.getElementsByTagName("span")[0];n?(a.style.backgroundPosition=e.XShift+" "+r,e.onmouseover=function(){a.style.backgroundPosition=this.XShift+" "+i},e.onmouseout=function(){a.style.backgroundPosition=this.XShift+" "+r},m&&(e.onmousedown=function(){p.activeElement&&p.activeElement!==t.input||(t.ieCachedRange=document.selection.createRange(),t.ieCachedScrollTop=t.input.scrollTop)}),e.isHelp||(e.onclick=function(){return this.onmouseout&&this.onmouseout(),l(this),!1})):(a.style.backgroundPosition=e.XShift+" "+o,e.onmouseover=e.onmouseout=e.onclick=function(){})}function d(e){return"string"==typeof e&&(e=i[e]),function(){e.apply(i,arguments)}}function f(){var n=t.buttonBar,r=document.createElement("ul");r.id="wmd-button-row"+e,r.className="wmd-button-row",r=n.appendChild(r);var o=0,i=function(t,n,i,a){var s=document.createElement("li");s.className="wmd-button",s.style.left=o+"px",o+=25;var l=document.createElement("span");return s.id=t+e,s.appendChild(l),s.title=n,s.XShift=i,a&&(s.textOp=a),u(s,!0),r.appendChild(s),s},l=function(t){var n=document.createElement("li");n.className="wmd-spacer wmd-spacer"+t,n.id="wmd-spacer"+t+e,r.appendChild(n),o+=25};b.bold=i("wmd-bold-button",s("bold"),"0px",d("doBold")),b.italic=i("wmd-italic-button",s("italic"),"-20px",d("doItalic")),l(1),b.link=i("wmd-link-button",s("link"),"-40px",d(function(e,t){return this.doLinkOrImage(e,t,!1)})),b.quote=i("wmd-quote-button",s("quote"),"-60px",d("doBlockquote")),b.code=i("wmd-code-button",s("code"),"-80px",d("doCode")),b.image=i("wmd-image-button",s("image"),"-100px",d(function(e,t){return this.doLinkOrImage(e,t,!0)})),l(2),b.olist=i("wmd-olist-button",s("olist"),"-120px",d(function(e,t){this.doList(e,t,!0)})),b.ulist=i("wmd-ulist-button",s("ulist"),"-140px",d(function(e,t){this.doList(e,t,!1)})),b.heading=i("wmd-heading-button",s("heading"),"-160px",d("doHeading")),b.hr=i("wmd-hr-button",s("hr"),"-180px",d("doHorizontalRule")),l(3),b.undo=i("wmd-undo-button",s("undo"),"-200px",null),b.undo.execute=function(e){e&&e.undo()};var c=/win/.test(h.platform.toLowerCase())?s("redo"):s("redomac");if(b.redo=i("wmd-redo-button",c,"-220px",null),b.redo.execute=function(e){e&&e.redo()},a){var p=document.createElement("li"),f=document.createElement("span");p.appendChild(f),p.className="wmd-button wmd-help-button",p.id="wmd-help-button"+e,p.XShift="-240px",p.isHelp=!0,p.style.right="0px",p.title=s("help"),p.onclick=a.handler,u(p,!0),r.appendChild(p),b.help=p}g()}function g(){n&&(u(b.undo,n.canUndo()),u(b.redo,n.canRedo()))}var v=t.input,b={};f(),c.addEvent(v,"keydown",function(e){if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey){var t=e.charCode||e.keyCode,n=String.fromCharCode(t).toLowerCase();switch(n){case"b":l(b.bold);break;case"i":l(b.italic);break;case"l":l(b.link);break;case"q":l(b.quote);break;case"k":l(b.code);break;case"g":l(b.image);break;case"o":l(b.olist);break;case"u":l(b.ulist);break;case"h":l(b.heading);break;case"r":l(b.hr);break;case"y":l(b.redo);break;case"z":e.shiftKey?l(b.redo):l(b.undo);break;default:return}e.preventDefault&&e.preventDefault(),window.event&&(window.event.returnValue=!1)}}),c.addEvent(v,"keyup",function(e){if(e.shiftKey&&!e.ctrlKey&&!e.metaKey){var t=e.charCode||e.keyCode;if(13===t){var n={};n.textOp=d("doAutoindent"),l(n)}}}),m&&c.addEvent(v,"keydown",function(e){var t=e.keyCode;return 27===t?!1:void 0}),this.setUndoRedoButtonStates=g}function s(e,t){this.hooks=e,this.getString=t}function l(e){return e.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/,function(e,t,n){return t=t.replace(/\?.*$/,function(e){return e.replace(/\+/g," ")}),t=decodeURIComponent(t),t=encodeURI(t).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29"),t=t.replace(/\?.*$/,function(e){return e.replace(/\+/g,"%2b")}),n&&(n=n.trim?n.trim():n.replace(/^\s*/,"").replace(/\s*$/,""),n=n.replace(/"/g,"quot;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;").replace(/</g,"&lt;").replace(/>/g,"&gt;")),n?t+' "'+n+'"':t})}var c={},u={},d={},p=window.document,f=window.RegExp,h=window.navigator,g={lineLength:72},m=/msie/.test(h.userAgent.toLowerCase()),v={bold:"Strong <strong> Ctrl+B",boldexample:"strong text",italic:"Emphasis <em> Ctrl+I",italicexample:"emphasized text",link:"Hyperlink <a> Ctrl+L",linkdescription:"enter link description here",linkdialog:'<p><b>Insert Hyperlink</b></p><p>http://example.com/ "optional title"</p>',quote:"Blockquote <blockquote> Ctrl+Q",quoteexample:"Blockquote",code:"Code Sample <pre><code> Ctrl+K",codeexample:"enter code here",image:"Image <img> Ctrl+G",imagedescription:"enter image description here",imagedialog:"<p><b>Insert Image</b></p><p>http://example.com/images/diagram.jpg \"optional title\"<br><br>Need <a href='http://www.google.com/search?q=free+image+hosting' target='_blank'>free image hosting?</a></p>",olist:"Numbered List <ol> Ctrl+O",ulist:"Bulleted List <ul> Ctrl+U",litem:"List item",heading:"Heading <h1>/<h2> Ctrl+H",headingexample:"Heading",hr:"Horizontal Rule <hr> Ctrl+R",undo:"Undo - Ctrl+Z",redo:"Redo - Ctrl+Y",redomac:"Redo - Ctrl+Shift+Z",help:"Markdown Editing Help"},b="http://",y="http://";r.Editor=function(e,o,l){l=l||{},l.strings=l.strings||{},l.helpButton&&(l.strings.help=l.strings.help||l.helpButton.title);var c=function(e){return l.strings[e]||v[e]};o=o||"";var u=this.hooks=new r.HookCollection;u.addNoop("onPreviewRefresh"),u.addNoop("postBlockquoteCreation"),u.addFalse("insertImageDialog"),this.getConverter=function(){return e};var d,f=this;this.run=function(){if(!d){d=new t(o);var r,h,g=new s(u,c),m=new i(e,d,function(){u.onPreviewRefresh()});/\?noundo/.test(p.location.href)||(r=new n(function(){m.refresh(),h&&h.setUndoRedoButtonStates()},d),this.textOperation=function(e){r.setCommandMode(),e(),f.refreshPreview()}),h=new a(o,d,r,m,g,l.helpButton,c),h.setUndoRedoButtonStates();var v=f.refreshPreview=function(){m.refresh(!0)};v()}}},e.prototype.findTags=function(e,t){var n,r=this;e&&(n=c.extendRegExp(e,"","$"),this.before=this.before.replace(n,function(e){return r.startTag=r.startTag+e,""}),n=c.extendRegExp(e,"^",""),this.selection=this.selection.replace(n,function(e){return r.startTag=r.startTag+e,""})),t&&(n=c.extendRegExp(t,"","$"),this.selection=this.selection.replace(n,function(e){return r.endTag=e+r.endTag,""}),n=c.extendRegExp(t,"^",""),this.after=this.after.replace(n,function(e){return r.endTag=e+r.endTag,""}))},e.prototype.trimWhitespace=function(e){var t,n,r=this;e?t=n="":(t=function(e){return r.before+=e,""},n=function(e){return r.after=e+r.after,""}),this.selection=this.selection.replace(/^(\s*)/,t).replace(/(\s*)$/,n)},e.prototype.skipLines=function(e,t,n){void 0===e&&(e=1),void 0===t&&(t=1),e++,t++;var r,o;if(navigator.userAgent.match(/Chrome/)&&"X".match(/()./),this.selection=this.selection.replace(/(^\n*)/,""),this.startTag=this.startTag+f.$1,this.selection=this.selection.replace(/(\n*$)/,""),this.endTag=this.endTag+f.$1,this.startTag=this.startTag.replace(/(^\n*)/,""),this.before=this.before+f.$1,this.endTag=this.endTag.replace(/(\n*$)/,""),this.after=this.after+f.$1,this.before){for(r=o="";e--;)r+="\\n?",o+="\n";n&&(r="\\n*"),this.before=this.before.replace(new f(r+"$",""),o)}if(this.after){for(r=o="";t--;)r+="\\n?",o+="\n";n&&(r="\\n*"),this.after=this.after.replace(new f(r,""),o)}},c.isVisible=function(e){return window.getComputedStyle?"none"!==window.getComputedStyle(e,null).getPropertyValue("display"):e.currentStyle?"none"!==e.currentStyle.display:void 0},c.addEvent=function(e,t,n){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener(t,n,!1)},c.removeEvent=function(e,t,n){e.detachEvent?e.detachEvent("on"+t,n):e.removeEventListener(t,n,!1)},c.fixEolChars=function(e){return e=e.replace(/\r\n/g,"\n"),e=e.replace(/\r/g,"\n")},c.extendRegExp=function(e,t,n){(null===t||void 0===t)&&(t=""),(null===n||void 0===n)&&(n="");var r,o=""+e;return o=o.replace(/\/([gim]*)$/,function(e,t){return r=t,""}),o=o.replace(/(^\/|\/$)/g,""),o=t+o+n,new f(o,r)},u.getTop=function(e,t){var n=e.offsetTop;if(!t)for(;e=e.offsetParent;)n+=e.offsetTop;return n},u.getHeight=function(e){return e.offsetHeight||e.scrollHeight},u.getWidth=function(e){return e.offsetWidth||e.scrollWidth},u.getPageSize=function(){var e,t,n,r;self.innerHeight&&self.scrollMaxY?(e=p.body.scrollWidth,t=self.innerHeight+self.scrollMaxY):p.body.scrollHeight>p.body.offsetHeight?(e=p.body.scrollWidth,t=p.body.scrollHeight):(e=p.body.offsetWidth,t=p.body.offsetHeight),self.innerHeight?(n=self.innerWidth,r=self.innerHeight):p.documentElement&&p.documentElement.clientHeight?(n=p.documentElement.clientWidth,r=p.documentElement.clientHeight):p.body&&(n=p.body.clientWidth,r=p.body.clientHeight);var o=Math.max(e,n),i=Math.max(t,r);return[o,i,n,r]},d.createBackground=function(){var e=p.createElement("div"),t=e.style;e.className="wmd-prompt-background",t.position="absolute",t.top="0",t.zIndex="1000",m?t.filter="alpha(opacity=50)":t.opacity="0.5";var n=u.getPageSize();return t.height=n[1]+"px",m?(t.left=p.documentElement.scrollLeft,t.width=p.documentElement.clientWidth):(t.left="0",t.width="100%"),p.body.appendChild(e),e},d.prompt=function(e,t,n){var r,o;void 0===t&&(t="");var i=function(e){var t=e.charCode||e.keyCode;27===t&&a(!0)},a=function(e){c.removeEvent(p.body,"keydown",i);var t=o.value;return e?t=null:(t=t.replace(/^http:\/\/(https?|ftp):\/\//,"$1://"),/^(?:https?|ftp):\/\//.test(t)||(t="http://"+t)),r.parentNode.removeChild(r),n(t),!1},s=function(){r=p.createElement("div"),r.className="wmd-prompt-dialog",r.style.padding="10px;",r.style.position="fixed",r.style.width="400px",r.style.zIndex="1001";var n=p.createElement("div");n.innerHTML=e,n.style.padding="5px",r.appendChild(n);var s=p.createElement("form"),l=s.style;s.onsubmit=function(){return a(!1)},l.padding="0",l.margin="0",l.cssFloat="left",l.width="100%",l.textAlign="center",l.position="relative",r.appendChild(s),o=p.createElement("input"),o.type="text",o.value=t,l=o.style,l.display="block",l.width="80%",l.marginLeft=l.marginRight="auto",s.appendChild(o);var d=p.createElement("input");d.type="button",d.onclick=function(){return a(!1)},d.value="OK",l=d.style,l.margin="10px",l.display="inline",l.width="7em";var f=p.createElement("input");f.type="button",f.onclick=function(){return a(!0)},f.value="Cancel",l=f.style,l.margin="10px",l.display="inline",l.width="7em",s.appendChild(d),s.appendChild(f),c.addEvent(p.body,"keydown",i),r.style.top="50%",r.style.left="50%",r.style.display="block",p.body.appendChild(r),r.style.marginTop=-(u.getHeight(r)/2)+"px",r.style.marginLeft=-(u.getWidth(r)/2)+"px"};setTimeout(function(){s();var e=t.length;if(void 0!==o.selectionStart)o.selectionStart=0,o.selectionEnd=e;else if(o.createTextRange){var n=o.createTextRange();n.collapse(!1),n.moveStart("character",-e),n.moveEnd("character",e),n.select()}o.focus()},0)};var w=s.prototype;w.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)",w.unwrap=function(e){var t=new f("([^\\n])\\n(?!(\\n|"+this.prefixes+"))","g");e.selection=e.selection.replace(t,"$1 $2")},w.wrap=function(e,t){this.unwrap(e);var n=new f("(.{1,"+t+"})( +|$\\n?)","gm"),r=this;e.selection=e.selection.replace(n,function(e,t){return new f("^"+r.prefixes,"").test(e)?e:t+"\n"}),e.selection=e.selection.replace(/\s+$/,"")},w.doBold=function(e,t){return this.doBorI(e,t,2,this.getString("boldexample"))},w.doItalic=function(e,t){return this.doBorI(e,t,1,this.getString("italicexample"))},w.doBorI=function(e,t,n,r){e.trimWhitespace(),e.selection=e.selection.replace(/\n{2,}/g,"\n");var o=/(\**$)/.exec(e.before)[0],i=/(^\**)/.exec(e.after)[0],a=Math.min(o.length,i.length);if(a>=n&&(2!=a||1!=n))e.before=e.before.replace(f("[*]{"+n+"}$",""),""),e.after=e.after.replace(f("^[*]{"+n+"}",""),"");else if(!e.selection&&i){e.after=e.after.replace(/^([*_]*)/,""),e.before=e.before.replace(/(\s?)$/,"");var s=f.$1;e.before=e.before+i+s}else{e.selection||i||(e.selection=r);var l=1>=n?"*":"**";e.before=e.before+l,e.after=l+e.after}},w.stripLinkDefs=function(e,t){return e=e.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(e,n,r,o,i){return t[n]=e.replace(/\s*$/,""),o?(t[n]=e.replace(/["(](.+?)[")]$/,""),o+i):""})},w.addLinkDef=function(e,t){var n=0,r={};e.before=this.stripLinkDefs(e.before,r),e.selection=this.stripLinkDefs(e.selection,r),e.after=this.stripLinkDefs(e.after,r);var o="",i=/(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g,a=function(e){n++,e=e.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+n+"]:"),o+="\n"+e},s=function(e,t,o,l,c,u){return o=o.replace(i,s),r[c]?(a(r[c]),t+o+l+n+u):e};e.before=e.before.replace(i,s),t?a(t):e.selection=e.selection.replace(i,s);var l=n;return e.after=e.after.replace(i,s),e.after&&(e.after=e.after.replace(/\n*$/,"")),e.after||(e.selection=e.selection.replace(/\n*$/,"")),e.after+="\n\n"+o,l},w.doLinkOrImage=function(e,t,n){e.trimWhitespace(),e.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/);var r;if(!(e.endTag.length>1&&e.startTag.length>0)){if(e.selection=e.startTag+e.selection+e.endTag,e.startTag=e.endTag="",/\n\n/.test(e.selection))return this.addLinkDef(e,null),void 0;var o=this,i=function(i){if(r.parentNode.removeChild(r),null!==i){e.selection=(" "+e.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g,"$1\\").substr(1);var a=" [999]: "+l(i),s=o.addLinkDef(e,a);e.startTag=n?"![":"[",e.endTag="]["+s+"]",e.selection||(e.selection=n?o.getString("imagedescription"):o.getString("linkdescription"))}t()};return r=d.createBackground(),n?this.hooks.insertImageDialog(i)||d.prompt(this.getString("imagedialog"),b,i):d.prompt(this.getString("linkdialog"),y,i),!0}e.startTag=e.startTag.replace(/!?\[/,""),e.endTag="",this.addLinkDef(e,null)},w.doAutoindent=function(e){var t=this,n=!1;e.before=e.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n"),e.before=e.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n"),e.before=e.before.replace(/(\n|^)[ \t]+\n$/,"\n\n"),e.selection||/^[ \t]*(?:\n|$)/.test(e.after)||(e.after=e.after.replace(/^[^\n]*/,function(t){return e.selection=t,""}),n=!0),/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(e.before)&&t.doList&&t.doList(e),/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(e.before)&&t.doBlockquote&&t.doBlockquote(e),/(\n|^)(\t|[ ]{4,}).*\n$/.test(e.before)&&t.doCode&&t.doCode(e),n&&(e.after=e.selection+e.after,e.selection="")},w.doBlockquote=function(e){e.selection=e.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(t,n,r,o){return e.before+=n,e.after=o+e.after,r}),e.before=e.before.replace(/(>[ \t]*)$/,function(t,n){return e.selection=n+e.selection,""}),e.selection=e.selection.replace(/^(\s|>)+$/,""),e.selection=e.selection||this.getString("quoteexample");var t,n="",r="";if(e.before){for(var o=e.before.replace(/\n$/,"").split("\n"),i=!1,a=0;o.length>a;a++){var s=!1;t=o[a],i=i&&t.length>0,/^>/.test(t)?(s=!0,!i&&t.length>1&&(i=!0)):s=/^[ \t]*$/.test(t)?!0:i,s?n+=t+"\n":(r+=n+t,n="\n")}/(^|\n)>/.test(n)||(r+=n,n="")}e.startTag=n,e.before=r,e.after&&(e.after=e.after.replace(/^\n?/,"\n")),e.after=e.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(t){return e.endTag=t,""});var l=function(t){var n=t?"> ":"";e.startTag&&(e.startTag=e.startTag.replace(/\n((>|\s)*)\n$/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"})),e.endTag&&(e.endTag=e.endTag.replace(/^\n((>|\s)*)\n/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"}))};/^(?![ ]{0,3}>)/m.test(e.selection)?(this.wrap(e,g.lineLength-2),e.selection=e.selection.replace(/^/gm,"> "),l(!0),e.skipLines()):(e.selection=e.selection.replace(/^[ ]{0,3}> ?/gm,""),this.unwrap(e),l(!1),!/^(\n|^)[ ]{0,3}>/.test(e.selection)&&e.startTag&&(e.startTag=e.startTag.replace(/\n{0,2}$/,"\n\n")),!/(\n|^)[ ]{0,3}>.*$/.test(e.selection)&&e.endTag&&(e.endTag=e.endTag.replace(/^\n{0,2}/,"\n\n"))),e.selection=this.hooks.postBlockquoteCreation(e.selection),/\n/.test(e.selection)||(e.selection=e.selection.replace(/^(> *)/,function(t,n){return e.startTag+=n,""}))},w.doCode=function(e){var t=/\S[ ]*$/.test(e.before),n=/^[ ]*\S/.test(e.after);if(!n&&!t||/\n/.test(e.selection)){e.before=e.before.replace(/[ ]{4}$/,function(t){return e.selection=t+e.selection,""});var r=1,o=1;/(\n|^)(\t|[ ]{4,}).*\n$/.test(e.before)&&(r=0),/^\n(\t|[ ]{4,})/.test(e.after)&&(o=0),e.skipLines(r,o),e.selection?/^[ ]{0,3}\S/m.test(e.selection)?/\n/.test(e.selection)?e.selection=e.selection.replace(/^/gm,"    "):e.before+="    ":e.selection=e.selection.replace(/^[ ]{4}/gm,""):(e.startTag="    ",e.selection=this.getString("codeexample"))}else e.trimWhitespace(),e.findTags(/`/,/`/),e.startTag||e.endTag?e.endTag&&!e.startTag?(e.before+=e.endTag,e.endTag=""):e.startTag=e.endTag="":(e.startTag=e.endTag="`",e.selection||(e.selection=this.getString("codeexample")))},w.doList=function(e,t,n){function r(){var e;return n?(e=" "+l+". ",l++):e=" "+s+" ",e}function o(e){return void 0===n&&(n=/^\s*\d/.test(e)),e=e.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,r)}var i=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/,a=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/,s="-",l=1;if(e.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null),!e.before||/\n$/.test(e.before)||/^\n/.test(e.startTag)||(e.before+=e.startTag,e.startTag=""),e.startTag){var c=/\d+[.]/.test(e.startTag);if(e.startTag="",e.selection=e.selection.replace(/\n[ ]{4}/g,"\n"),this.unwrap(e),e.skipLines(),c&&(e.after=e.after.replace(a,o)),n==c)return}var u=1;e.before=e.before.replace(i,function(e){return/^\s*([*+-])/.test(e)&&(s=f.$1),u=/[^\n]\n\n[^\n]/.test(e)?1:0,o(e)}),e.selection||(e.selection=this.getString("litem"));var d=r(),p=1;e.after=e.after.replace(a,function(e){return p=/[^\n]\n\n[^\n]/.test(e)?1:0,o(e)}),e.trimWhitespace(!0),e.skipLines(u,p,!0),e.startTag=d;var h=d.replace(/./g," ");this.wrap(e,g.lineLength-h.length),e.selection=e.selection.replace(/\n/g,"\n"+h)},w.doHeading=function(e){if(e.selection=e.selection.replace(/\s+/g," "),e.selection=e.selection.replace(/(^\s+|\s+$)/g,""),!e.selection)return e.startTag="## ",e.selection=this.getString("headingexample"),e.endTag=" ##",void 0;var t=0;e.findTags(/#+[ ]*/,/[ ]*#+/),/#+/.test(e.startTag)&&(t=f.lastMatch.length),e.startTag=e.endTag="",e.findTags(null,/\s?(-+|=+)/),/=+/.test(e.endTag)&&(t=1),/-+/.test(e.endTag)&&(t=2),e.startTag=e.endTag="",e.skipLines(1,1);var n=0==t?2:t-1;if(n>0){var r=n>=2?"-":"=",o=e.selection.length;for(o>g.lineLength&&(o=g.lineLength),e.endTag="\n";o--;)e.endTag+=r}},w.doHorizontalRule=function(e){e.startTag="----------\n",e.selection="",e.skipLines(2,1,!0)}}(),e.exports=r}),e.register("rooms/libraries/path.js",function(e){var t={version:"0.8",map:function(e){return t.routes.defined.hasOwnProperty(e)?t.routes.defined[e]:new t.core.route(e)},root:function(e){t.routes.root=e},rescue:function(e){t.routes.rescue=e},history:{pushState:function(e,n,r){t.history.supported?t.dispatch(r)&&history.pushState(e,n,r):t.history.fallback&&(window.location.hash="#"+r)},popState:function(){t.dispatch(document.location.pathname)},listen:function(e){if(t.history.supported=!(!window.history||!window.history.pushState),t.history.fallback=e,t.history.supported)window.onpopstate=t.history.popState;else if(t.history.fallback){for(route in t.routes.defined)"#"!=route.charAt(0)&&(t.routes.defined["#"+route]=t.routes.defined[route],t.routes.defined["#"+route].path="#"+route);t.listen()}}},match:function(e,n){var r,o,i,a,s,l={},c=null;for(c in t.routes.defined)if(null!==c&&void 0!==c)for(c=t.routes.defined[c],r=c.partition(),a=0;r.length>a;a++){if(o=r[a],s=e,o.search(/:/)>0)for(i=0;o.split("/").length>i;i++)s.split("/").length>i&&":"===o.split("/")[i].charAt(0)&&(l[o.split("/")[i].replace(/:/,"")]=s.split("/")[i],s=s.replace(s.split("/")[i],o.split("/")[i]));if(o===s)return n&&(c.params=l),c}return null},dispatch:function(e){var n,r;if(t.routes.current!==e){if(t.routes.previous=t.routes.current,t.routes.current=e,r=t.match(e,!0),t.routes.previous&&(n=t.match(t.routes.previous),null!==n&&null!==n.do_exit&&n.do_exit()),null!==r)return r.run(),!0;null!==t.routes.rescue&&t.routes.rescue()}},listen:function(){var e=function(){t.dispatch(location.hash)};""===location.hash?null!==t.routes.root&&(location.hash=t.routes.root):t.dispatch(location.hash),"onhashchange"in window?window.onhashchange=e:setInterval(e,50)},core:{route:function(e){this.path=e,this.action=null,this.do_enter=[],this.do_exit=null,this.params={},t.routes.defined[e]=this}},routes:{current:null,root:null,rescue:null,previous:null,defined:{}}};t.core.route.prototype={to:function(e){return this.action=e,this},enter:function(e){return e instanceof Array?this.do_enter=this.do_enter.concat(e):this.do_enter.push(e),this},exit:function(e){return this.do_exit=e,this},partition:function(){for(var e,t,n=[],r=[],o=/\(([^}]+?)\)/g;e=o.exec(this.path);)n.push(e[1]);for(r.push(this.path.split("(")[0]),t=0;n.length>t;t++)r.push(r[r.length-1]+n[t]);return r},run:function(){var e,n,r=!1;if(t.routes.defined[this.path].hasOwnProperty("do_enter")&&t.routes.defined[this.path].do_enter.length>0)for(e=0;t.routes.defined[this.path].do_enter.length>e;e++)if(n=t.routes.defined[this.path].do_enter[e](),n===!1){r=!0;break}r||t.routes.defined[this.path].action()}},t.refresh=function(){t.routes.current=null,t.dispatch(location.hash)},e.exports=t}),e.register("rooms/template.js",function(e){function t(e,t){return 2===arguments.length?Mustache.to_html(n[e],t):1===arguments.length?function(t){return Mustache.to_html(n[e],t)}:void 0}var n={allocationEdit:'<h1>Edit allocations for accademic year beginning {{year}}</h1><hr /><div> {{#staircases}} <div class="allocationBlock"><h2>{{{name}}}</h2> {{#rooms}} <form data-old-allocation="{{allocation}}" data-roomid="{{id}}"> {{name}}: <input name="allocation" type="text" value="{{allocation}}" /></form> {{/rooms}} </div> {{/staircases}}</div>',choosingOrderEdit:'<div id="tabs"><ul><li><a href="#tabs-1">First Years</a></li><li><a href="#tabs-2">Second Years</a></li><li><a href="#tabs-3">Third Years</a></li></ul><div id="tabs-1"><ul id="sortable" class="sortable"><li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>Joe Blogs <button> Delete</button></li><li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>John Smith </li></ul></div><div id="tabs-2"> Second Years </div><div id="tabs-3"> Third Years </div></div>',markdownEdit:'<form><div class="wmd-panel"><div id="wmd-button-bar"></div><textarea class="wmd-input" id="wmd-input" name="content">{{{Content}}}</textarea></div><div id="wmd-preview" class="wmd-panel wmd-preview"></div><input type="submit" value="Save" /></form><div id="getImage" class="dialog" title="Insert Image"><label> Select an image to upload</label><br /><input type="file" required /></div><div id="busy" class="dialog" title="Uploading"><div class="ajaxLoader"></div></div><div id="getURL" class="dialog" title="Insert Hyperlink"><form><label> http://example.com/ "optional title"</label><br /><input name="fileUpload" type="url" value="http://" /><br /></form></div>',NavigationList:'{{#Links}} <a href="{{url}}" {{#selected}}class="Selected"{{/selected}}>{{{name}}}</a>{{/Links}}',navigationTableEdit:'<h2> Add New</h2><form><label>ID</label><input name="id" type="text" /><label>Name</label><input name="name" type="text" required /><br /><label>Parent ID</label><input name="parentid" type="text" value="{{parentid}}" /><label>Type</label><select name="type"><option>staircase</option><option selected>room</option><option>page</option><option>special</option></select><br /><label>Weight</label><input name="weight" type="number" /><label>Bathroom Sharing</label><input name="bathroomsharing" type="number" value="{{bathroomsharing}}" /><br /><label>Rent Band</label><input name="rentband" type="number" value="{{rentband}}" /><label>Floor</label><input name="floor" type="number" value="{{floor}}" /><br /><input type="submit" value="Save" /></form><h2> Edit Existing</h2><table><tr><th> ID </th><th> Name </th><th> Parent ID </th><th> Type </th><th> Weight </th><th> Bathroom Sharing </th><th> Rent Band </th><th> Floor </th><th></th></tr> {{#Navigation}} <tr itemid="{{id}}"><td itemprop="id" data-type="text"><!--Required but could be ""--><div>{{id}}</div><input style="display: none; width:110px" type="text" value="{{id}}" /></td><td itemprop="name" data-type="text"><div>{{{name}}}</div><input style="display: none; width:115px" type="text" required value="{{name}}" /></td><td itemprop="parentid" data-type="text"><!--Required but could be ""--><div>{{parentid}}</div><input style="display: none; width:40px" type="text" value="{{parentid}}" /></td><td itemprop="type" data-type="text" style="width: 84px"><div>{{type}}</div><select style="display: none;" required ><option {{#isStaircase}}selected{{/isStaircase}}>staircase</option><option {{#isRoom}}selected{{/isRoom}}>room</option><option {{#isPage}}selected{{/isPage}}>page</option><option {{#isSpecial}}selected{{/isSpecial}}>special</option></select></td><td itemprop="weight" data-type="text"><div>{{weight}}</div><input style="display: none; width: 45px" type="number" value="{{weight}}" /></td><td itemprop="bathroomsharing" data-type="text"><div>{{bathroomsharing}}</div><input style="display: none; width:30px" type="number" value="{{bathroomsharing}}" /></td><td itemprop="rentband" data-type="text"><div>{{rentband}}</div><input style="display: none; width:30px" type="number" value="{{rentband}}" /></td><td itemprop="floor" data-type="text"><div>{{floor}}</div><input style="display: none; width:30px" type="number" value="{{floor}}" /></td><td><button>Delete</button></td></tr> {{/Navigation}}</table>',projector:'{{#staircases}}<div class="projectorBlock"><h1><a href="{{url}}">{{{name}}}</a></h1><ul> {{#rooms}} <li id="{{id}}" class="{{css}}"><a href="{{url}}">{{{name}}}<span class="allocationDisplayPart"> - <span class="allocationDisplay" data-roomid="{{id}}"></span></span></a></li> {{/rooms}} </ul></div>{{/staircases}}',room:'{{#rentband}}<table class="horizontalTable"><tr><th> Bathroom </th><td> {{bathroom}} </td></tr><tr><th> Rent Band </th><td> {{rentBandDescription}} </td></tr><tr><th> Floor </th><td> {{floorDescription}} </td></tr><tr><th> Current Allocation </th><td><span class="allocationDisplay" data-roomid="{{id}}" data-year="current"></span></td></tr><tr><th> Next Year\'s Allocation </th><td><span class="allocationDisplay" data-roomid="{{id}}" data-year="next"></span></td></tr></table>{{/rentband}}',staircase:'{{#Floors}}<h2> {{Name}}</h2><ul> {{#Rooms}} <li><a href="{{url}}">{{nameSingleLine}}{{#rentband}} - {{#bathroom}}{{bathroom}}, {{/bathroom}}{{rentBandDescription}}, <span class="allocationDisplay" data-roomid="{{id}}"></span>{{/rentband}}</a></li> {{/Rooms}}</ul>{{/Floors}}'};
t.templates=n,e.exports=t}),e.register("rooms/server.js",function(e){function t(e,t){var n=Object.create(e);return n.method="PUT",void 0!==t&&(n.isNew=t),n}function n(e){var t=Object.create(e);return t.method="DELETE",t}var r="/rooms/",o={};e.exports={prefix:r,markdown:{read:function(e,t){var n=e.id;o[n]?setTimeout(function(){t(o[n])},0):$.getJSON(r+"data/markdown",{id:n},function(r){function i(e){o[n]=e,t(e)}if(null===r){var a="===============================================";i(e.name+"\n"+(e.name&&a.substr(0,e.name.length)||a.substr(0,n.length))+"\n\nThere is no description for this "+e.type+", why not consider adding one?")}else i(r)})},update:function(e,n,i){o[e]=n,$.post(r+"data/markdown",t({id:e,content:n}),i)}},navigation:{create:function(e,n){$.post(r+"data/navigation",t(e,!0),n)},read:function(e){$.getJSON(r+"data/navigation",e)},update:function(e,n,o,i){$.post(r+"data/navigation",t({id:e,name:n,value:o},!1),i)},del:function(e,t){$.post(r+"data/navigation",n({id:e}),t)}},allocation:{update:function(e,n,o,i){$.post(r+"data/allocations",t({roomid:e,year:n,crsid:o}),i)}},choosingOrder:{read:function(e){$.getJSON(r+"data/choosingorder",e)}}}}),e.register("rooms/stream.js",function(e,t,n){var r=n("./server"),o=n("emitter");e.exports=function(){function e(e,t){return Object.create({year:function(){var e=new Date;return(e.getMonth()>6?e.getFullYear():e.getFullYear()-1)+t}(),defaultText:e})}function t(e){for(var t=0;e.allocations.length>t;t++){var n=e.allocations[t];n.year=parseInt(n.year,10),n.timestamp=parseInt(n.timestamp,10),(void 0===s.timestamp||n.timestamp>s.timestamp)&&(s.timestamp=n.timestamp);var r=n.roomid,o=n.crsid,i=n.year,a={};i===l.allocationsThisYear.year?a=l.allocationsThisYear:i===l.allocationsNextYear.year&&(a=l.allocationsNextYear),a[r]=o}return l}function n(){var e=[];for(var t in l.defaultAllocations())l.defaultAllocations().hasOwnProperty(t)&&e.push({roomid:t,crsid:l.defaultAllocations()[t],year:l.defaultAllocations().year});return{allocations:e}}var i=new o,a=function(){function e(e){var n;for(n=0;t.length>n;n++)t[n](e)}var t=[],n=!1,o=function(e){n=e},i=function(){return!1};return $(function(){function t(){if("undefined"!=typeof io){var t="http://rcsa-rooms-stream.herokuapp.com/",r=io.connect(t),a=r.socket,s=!1;o=function(e){n=e||n,n&&a.connected&&r.emit("auth",n,function(){s=!0})},r.on("authRequired",function(){o()}),r.on("message",function(t){e(JSON.parse(t))});var l=0;setInterval(function(){i()?(e({}),l=0):(l++,l>600+Math.floor(60*Math.random())&&(l=0,location.reload(!1)))},1e3),a.on("reconnect_failed",function(){setTimeout(function(){window.location.reload(!1)},500)}),i=function(){return a.connected&&s}}}var r=document.createElement("script");r.type="text/javascript",r.src="http://rcsa-rooms-stream.herokuapp.com/socket.io/socket.io.js",r.async=!1,r.onreadystatechange=r.onload=function(){var e=r.readyState;t.done||e&&!/loaded|complete/.test(e)||(t.done=!0,t())},document.body.appendChild(r)}),function(){function t(){function n(n,r){var s=new Date;n.auth&&n.auth.notificationKey&&o(n.auth.notificationKey),e(n),setTimeout(t,(i()?24e4:r)+10*(s.getTime()-a.getTime()))}var a=new Date;$.ajax({url:r.prefix+"data/stream",dataType:"json",data:s,success:function(e){n(e,5e3)},error:function(e,t){n(t,12e4)}})}t()}(),function(e){return t.push(e),function(){t=t.filter(function(t){return t!=e})}}}(),s={};a(function(e){i.emit("raw",e)});var l={allocationsThisYear:e("Unknown",0),allocationsNextYear:e("Available",1),defaultAllocations:function(){return 0===$("#isThisYears:checked").length?this.allocationsNextYear:this.allocationsThisYear},loaded:!1};return i.on("raw",function(e){if(e.auth&&(s.auth=e.auth.isAuthenticated,i.emit("auth",e.auth)),e.allocations){l.loaded=!0,i.emit("allocations",t(e));for(var n=0;e.allocations.length>n;n++)i.emit("allocation",e.allocations[n]),l.defaultAllocations().year===parseInt(e.allocations[n].year,10)&&i.emit("default-year-allocation",e.allocations[n])}}),i.onAllocationChanged=function(e){for(var t=n().allocations,r=0;t.length>r;r++)e(t[r]);return i.on("default-year-allocation",e),function(){i.off("default-year-allocation",e)}},i.getAllocations=function(e){l.loaded?e(l):i.once("allocations",e)},i}()}),e.alias("ForbesLindesay-curry/index.js","rooms/deps/curry/index.js"),e.alias("ForbesLindesay-queue/index.js","rooms/deps/queue/index.js"),e.alias("ForbesLindesay-to-bool-function/index.js","rooms/deps/to-bool-function/index.js"),e.alias("component-to-function/index.js","ForbesLindesay-to-bool-function/deps/to-function/index.js"),e.alias("component-type/index.js","ForbesLindesay-to-bool-function/deps/type/index.js"),e.alias("ForbesLindesay-base64-encode/index.js","rooms/deps/base64-encode/index.js"),e.alias("ForbesLindesay-utf8-encode/index.js","ForbesLindesay-base64-encode/deps/utf8-encode/index.js"),e.alias("ForbesLindesay-imgur/index.js","rooms/deps/imgur/index.js"),e.alias("ForbesLindesay-promises-a/index.js","ForbesLindesay-imgur/deps/promises-a/index.js"),e.alias("component-emitter/index.js","ForbesLindesay-imgur/deps/emitter/index.js"),e.alias("component-find/index.js","rooms/deps/find/index.js"),e.alias("component-to-function/index.js","component-find/deps/to-function/index.js"),e.alias("component-group-by/index.js","rooms/deps/group-by/index.js"),e.alias("component-to-function/index.js","component-group-by/deps/to-function/index.js"),e.alias("component-emitter/index.js","rooms/deps/emitter/index.js"),window.rooms=e("rooms")})();